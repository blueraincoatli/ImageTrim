name: Build Multi-Platform

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'v1.0.0'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact_name: imagetrim
            artifact_archive: ImageTrim-1.0.0-linux.tar.gz
          - os: windows-latest
            platform: windows
            artifact_name: ImageTrim.exe
            artifact_archive: ImageTrim-1.0.0-win.zip
          - os: macos-latest
            platform: macos
            artifact_name: ImageTrim.app
            artifact_archive: ImageTrim-1.0.0-macos.tar.gz

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Create virtual environment
      run: uv venv

    - name: Install dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        uv pip install pyinstaller

    - name: Install system dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk python3-dev libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 libxcb-xinerama0

    - name: Install system dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        # macOS ç³»ç»Ÿä¾èµ–é€šå¸¸å·²åŒ…å«åœ¨ç³»ç»Ÿä¸­
        echo "macOS dependencies check"

    - name: Create build directories
      run: |
        mkdir -p build/macos
        mkdir -p build/linux

    - name: Create macOS Info.plist
      if: matrix.platform == 'macos'
      run: |
        cat > build/macos/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleName</key>
            <string>ImageTrim</string>
            <key>CFBundleDisplayName</key>
            <string>ImageTrim</string>
            <key>CFBundleIdentifier</key>
            <string>com.imagetrim.imagetrim</string>
            <key>CFBundleVersion</key>
            <string>1.0.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundleExecutable</key>
            <string>ImageTrim</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.14</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>NSSupportsAutomaticGraphicsSwitching</key>
            <true/>
        </dict>
        </plist>
        EOF

    - name: Create Linux .desktop file
      if: matrix.platform == 'linux'
      run: |
        cat > build/linux/imagetrim.desktop << 'EOF'
        [Desktop Entry]
        Name=ImageTrim
        Name[zh_CN]=å›¾ç‰‡å»é‡å·¥å…·
        Comment=Image deduplication and conversion tool
        Comment[zh_CN]=å›¾ç‰‡å»é‡å’Œæ ¼å¼è½¬æ¢å·¥å…·
        Exec=imagetrim
        Icon=imagetrim
        Terminal=false
        Type=Application
        Categories=Graphics;Photography;
        MimeType=image/jpeg;image/png;image/webp;image/avif;
        StartupWMClass=ImageTrim
        EOF

    - name: Build application
      run: |
        python build_cross_platform.py

    - name: Create additional packages (Linux)
      if: matrix.platform == 'linux'
      run: |
        # Create AppImage
        mkdir -p ImageTrim.AppDir/usr/bin
        mkdir -p ImageTrim.AppDir/usr/share/applications
        mkdir -p ImageTrim.AppDir/usr/share/icons/hicolor/256x256/apps

        cp dist/imagetrim ImageTrim.AppDir/usr/bin/
        cp build/linux/imagetrim.desktop ImageTrim.AppDir/usr/share/applications/

        # Create AppRun
        cat > ImageTrim.AppDir/AppRun << 'EOFRUN'
        #!/bin/sh
        HERE="$(dirname "$(readlink -f "${0}")")"
        export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}"
        export PATH="${HERE}/usr/bin:${PATH}"
        exec "${HERE}/usr/bin/imagetrim" "$@"
        EOFRUN
        chmod +x ImageTrim.AppDir/AppRun

        # Download appimagetool
        wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
        chmod +x appimagetool
        ./appimagetool ImageTrim.AppDir ImageTrim-1.0.0-linux.AppImage

    - name: Create DMG (macOS)
      if: matrix.platform == 'macos'
      run: |
        if [ -f "dist/ImageTrim.app" ]; then
          mkdir -p dmg_temp
          cp -R "dist/ImageTrim.app" dmg_temp/
          ln -s /Applications dmg_temp/Applications
          hdiutil create -volname "ImageTrim" -srcfolder dmg_temp -ov -format UDZO ImageTrim-1.0.0-macos.dmg
          rm -rf dmg_temp
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-build
        path: |
          dist/
          archives/
          *.AppImage
          *.dmg
        retention-days: 30

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Delete existing Release (if exists)
      run: |
        TAG_NAME="${GITHUB_REF#refs/tags/}"
        if gh release view "$TAG_NAME" >/dev/null 2>&1; then
          echo "ğŸ—‘ï¸ åˆ é™¤ç°æœ‰ Release: $TAG_NAME"
          gh release delete "$TAG_NAME" --yes
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create/Update Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/windows-build/dist/*.exe
          artifacts/windows-build/archives/*.zip
          artifacts/macos-build/dist/*.app/**
          artifacts/macos-build/archives/*.tar.gz
          artifacts/macos-build/*.dmg
          artifacts/linux-build/dist/imagetrim
          artifacts/linux-build/archives/*.tar.gz
          artifacts/linux-build/*.AppImage
        draft: false
        prerelease: false
        generate_release_notes: true
        name: "ImageTrim ${{ github.ref_name }}"
        body: |
          ## ğŸ‰ ImageTrim ${{ github.ref_name }} å‘å¸ƒ

          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - å›¾ç‰‡å»é‡åŠŸèƒ½
          - AVIFæ ¼å¼è½¬æ¢
          - ç°ä»£åŒ–UIç•Œé¢

          ### ğŸ¦ğŸ§ æ–°å¢æ”¯æŒå¹³å°
          - macOS åº”ç”¨ç¨‹åºåŒ… (.app)
          - Linux å¯æ‰§è¡Œæ–‡ä»¶å’Œ AppImage

          ### ğŸ“¦ ä¸‹è½½æ–‡ä»¶
          - **Windows**: `ImageTrim.exe`
          - **macOS**: `ImageTrim.app` æˆ– `.dmg` å®‰è£…åŒ…
          - **Linux**: `imagetrim` å¯æ‰§è¡Œæ–‡ä»¶æˆ– `.AppImage`

          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„æ–‡ä»¶
          2. Windows/macOS: åŒå‡»è¿è¡Œ
          3. Linux: `chmod +x imagetrim && ./imagetrim`

          ---
          ğŸ¤– è‡ªåŠ¨æ„å»ºäº GitHub Actions
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}