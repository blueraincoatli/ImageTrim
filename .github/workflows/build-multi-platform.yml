name: Build Multi-Platform

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false  # 允许其他平台继续即使一个失败
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact_name: imagetrim
            artifact_archive: ImageTrim-1.0.0-linux.tar.gz
          - os: windows-latest
            platform: windows
            artifact_name: ImageTrim.exe
            artifact_archive: ImageTrim-1.0.0-win.zip
          - os: macos-latest
            platform: macos
            artifact_name: ImageTrim.app
            artifact_archive: ImageTrim-1.0.0-macos.tar.gz

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Create virtual environment
      run: uv venv

    - name: Install dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        uv pip install pyinstaller

    - name: Install system dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        # 基础依赖
        sudo apt-get install -y python3-tk python3-dev

        # 尝试安装 OpenGL 相关包（兼容不同版本）
        sudo apt-get install -y libgl1-mesa-glx || sudo apt-get install -y libgl1 || echo "OpenGL package not found"
        sudo apt-get install -y libglu1-mesa-dev || sudo apt-get install -y libglu1 || echo "GLU package not found"

        # X11 和图形库
        sudo apt-get install -y libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 libxrandr2

        # 尝试安装其他依赖（可选）
        sudo apt-get install -y libxcb-xinerama0 || echo "xcb-xinerama not available"
        sudo apt-get install -y libxss1 || echo "xss not available"
        sudo apt-get install -y libdbus-1-3 || echo "dbus not available"
        sudo apt-get install -y libgtk-3-0 || echo "gtk3 not available"
        sudo apt-get install -y libasound2-dev || echo "alsa not available"

        # 安装UPX用于压缩
        sudo apt-get install -y upx-ucl || echo "UPX not available"

    - name: Install system dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        # macOS 系统依赖通常已包含在系统中
        echo "macOS dependencies check"
        # 安装UPX用于压缩
        brew install upx || echo "UPX not available via brew"

    - name: Install system dependencies (Windows)
      if: matrix.platform == 'windows'
      run: |
        # Windows 下载UPX用于压缩
        echo "Installing UPX for Windows..."
        curl -L -o upx.zip https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-win64.zip
        Expand-Archive -Path upx.zip -DestinationPath .
        Move-Item upx-4.2.2-win64/upx.exe upx.exe -Force
        echo "UPX installed"

    - name: Create build directories
      run: |
        mkdir -p build/macos
        mkdir -p build/linux

    # Info.plist will be handled by PyInstaller automatically

    - name: Create Linux .desktop file
      if: matrix.platform == 'linux'
      run: |
        cat > build/linux/imagetrim.desktop << 'EOF'
        [Desktop Entry]
        Name=ImageTrim
        Name[zh_CN]=图片去重工具
        Comment=Image deduplication and conversion tool
        Comment[zh_CN]=图片去重和格式转换工具
        Exec=imagetrim
        Icon=imagetrim
        Terminal=false
        Type=Application
        Categories=Graphics;Photography;
        MimeType=image/jpeg;image/png;image/webp;image/avif;
        StartupWMClass=ImageTrim
        EOF

    - name: Build application
      shell: bash
      run: |
        echo "Current directory contents:"
        ls -la
        echo "App directory contents:"
        ls -la app/ || echo "App directory not found"
        echo "Starting optimized build..."
        if [ "${{ matrix.platform }}" = "windows" ]; then
          .venv/Scripts/python build_optimized.py
        else
          .venv/bin/python build_optimized.py
        fi

    - name: Create additional packages (Linux)
      if: matrix.platform == 'linux'
      run: |
        # Check if build succeeded first
        if [ ! -f "dist/ImageTrim" ] && [ ! -f "dist/imagetrim" ]; then
          echo "Error: Linux binary not found in dist/"
          ls -la dist/ || echo "dist directory not found"
          exit 1
        fi

        # Find the actual binary name
        BINARY_NAME=""
        if [ -f "dist/ImageTrim" ]; then
          BINARY_NAME="ImageTrim"
        elif [ -f "dist/imagetrim" ]; then
          BINARY_NAME="imagetrim"
        fi

        echo "Found Linux binary: $BINARY_NAME"

        # Create AppImage
        mkdir -p ImageTrim.AppDir/usr/bin
        mkdir -p ImageTrim.AppDir/usr/share/applications
        mkdir -p ImageTrim.AppDir/usr/share/icons/hicolor/256x256/apps

        cp dist/$BINARY_NAME ImageTrim.AppDir/usr/bin/imagetrim

        # Create desktop file directly in AppDir (don't rely on build/linux)
        cat > ImageTrim.AppDir/usr/share/applications/imagetrim.desktop << 'EOF'
        [Desktop Entry]
        Name=ImageTrim
        Name[zh_CN]=图片去重工具
        Comment=Image deduplication and conversion tool
        Comment[zh_CN]=图片去重和格式转换工具
        Exec=imagetrim
        Icon=imagetrim
        Terminal=false
        Type=Application
        Categories=Graphics;Photography;
        MimeType=image/jpeg;image/png;image/webp;image/avif;
        StartupWMClass=ImageTrim
        EOF

        # Create AppRun
        cat > ImageTrim.AppDir/AppRun << 'EOFRUN'
        #!/bin/sh
        HERE="$(dirname "$(readlink -f "${0}")")"
        export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}"
        export PATH="${HERE}/usr/bin:${PATH}"
        exec "${HERE}/usr/bin/imagetrim" "$@"
        EOFRUN
        chmod +x ImageTrim.AppDir/AppRun

        # Download appimagetool
        wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
        chmod +x appimagetool

        # Verify desktop file exists
        echo "Checking desktop file location:"
        ls -la ImageTrim.AppDir/usr/share/applications/
        echo "Checking AppDir structure:"
        ls -la ImageTrim.AppDir/

        # Create desktop file also at root level (some versions of appimagetool require this)
        cp ImageTrim.AppDir/usr/share/applications/imagetrim.desktop ImageTrim.AppDir/imagetrim.desktop

        echo "Creating AppImage with verbose output..."
        if ! ./appimagetool --verbose ImageTrim.AppDir ImageTrim-1.0.7-linux.AppImage; then
          echo "Standard AppImage creation failed, trying alternative approach..."
          if ! ./appimagetool --no-appstream ImageTrim.AppDir ImageTrim-1.0.7-linux.AppImage; then
            echo "Final attempt: creating AppImage without desktop integration..."
            ./appimagetool --no-appstream --no-desktop ImageTrim.AppDir ImageTrim-1.0.7-linux.AppImage || echo "All AppImage creation attempts failed"
          fi
        fi

    - name: Create DMG (macOS)
      if: matrix.platform == 'macos'
      run: |
        if [ -f "dist/ImageTrim.app" ]; then
          mkdir -p dmg_temp
          cp -R "dist/ImageTrim.app" dmg_temp/
          ln -s /Applications dmg_temp/Applications
          hdiutil create -volname "ImageTrim" -srcfolder dmg_temp -ov -format UDZO ImageTrim-1.1.4-macos.dmg
          rm -rf dmg_temp
        fi

    - name: Show build results
      shell: bash
      run: |
        echo "=== Build Results for ${{ matrix.platform }} ==="
        echo "Contents of dist/:"
        ls -la dist/ || echo "dist directory not found"
        echo ""
        echo "Root directory files:"
        ls -la *.AppImage *.dmg 2>/dev/null || echo "No AppImage or DMG files found"
        echo ""
        echo "Total size of dist/:"
        du -sh dist/ 2>/dev/null || echo "Cannot size dist/"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-build
        path: |
          dist/
          *.AppImage
          *.dmg
        retention-days: 30
        if-no-files-found: error

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display artifacts structure
      run: |
        echo "=== Artifacts Structure ==="
        find artifacts -type f -name "*" | head -20
        echo ""
        echo "Platform directories:"
        ls -la artifacts/ || echo "No artifacts directory"

    - name: Prepare release assets
      run: |
        mkdir -p release-assets

        echo "=== Full artifacts structure ==="
        find artifacts -type f | sort

        echo ""
        echo "=== Processing Windows artifacts ==="
        if [ -d "artifacts/windows-build" ]; then
          ls -la artifacts/windows-build/
          # 复制所有Windows文件
          cp -r artifacts/windows-build/* release-assets/ 2>/dev/null || echo "No Windows artifacts found"
        else
          echo "Windows build directory not found"
        fi

        echo ""
        echo "=== Processing macOS artifacts ==="
        if [ -d "artifacts/macos-build" ]; then
          ls -la artifacts/macos-build/
          # 复制所有macOS文件
          cp -r artifacts/macos-build/* release-assets/ 2>/dev/null || echo "No macOS artifacts found"
        else
          echo "macOS build directory not found"
        fi

        echo ""
        echo "=== Processing Linux artifacts ==="
        if [ -d "artifacts/linux-build" ]; then
          ls -la artifacts/linux-build/
          # 复制所有Linux文件
          cp -r artifacts/linux-build/* release-assets/ 2>/dev/null || echo "No Linux artifacts found"
        else
          echo "Linux build directory not found"
        fi

        echo ""
        echo "=== Final Release Assets ==="
        ls -la release-assets/
        echo "Total size:"
        du -sh release-assets/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: ImageTrim ${{ github.ref_name }} - 优化版本
        body: |
          ## ImageTrim ${{ github.ref_name }} - 大幅优化版本

          ### 重大改进
          - **文件体积减少50%**: 从87-104MB降至约40-70MB
          - **排除大型依赖**: 移除matplotlib(~50MB)、scipy(~40MB)、pandas(~20MB)
          - **启用UPX压缩**: 进一步压缩20-30%
          - **符号剥离**: 移除调试信息
          - **精确依赖**: 只包含必需的库

          ### 下载文件

          #### Windows
          - `ImageTrim.exe` - Windows可执行文件 (约40-60MB)

          #### macOS
          - `ImageTrim.app/` - macOS应用程序包 (目录形式，约40-60MB)
          - `ImageTrim-*.dmg` - macOS磁盘镜像 (如果生成)

          #### Linux
          - `ImageTrim` - Linux可执行文件 (约40-60MB)
          - `ImageTrim-*.AppImage` - Linux便携版 (如果生成)

          ### 使用方法
          1. **Windows**: 下载 `ImageTrim.exe` 直接运行
          2. **macOS**: 下载 `ImageTrim.app/` 目录，运行其中程序
          3. **Linux**: 下载 `ImageTrim` 文件，添加执行权限 `chmod +x ImageTrim`

          ### 重要说明
          - 所有文件都是**优化版本**，体积大幅减小
          - macOS的 `.app` 是目录形式，需要完整下载
          - Linux文件可能是 `ImageTrim` 或 `imagetrim` 名称

          ### 系统要求
          - Windows 10/11 (x64)
          - macOS 10.14+ (x64/ARM64)
          - Linux (x64, GLIBC 2.17+)

          ---
          自动构建 · 优化发布 · 体积减半
        files: release-assets/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}