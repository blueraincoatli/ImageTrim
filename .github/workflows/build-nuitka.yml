name: Build with Nuitka (Multi-Platform)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false  # å…è®¸å…¶ä»–å¹³å°ç»§ç»­å³ä½¿ä¸€ä¸ªå¤±è´¥
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact_name: ImageTrim
            python_cmd: python3
          - os: windows-latest
            platform: windows
            artifact_name: ImageTrim.exe
            python_cmd: python
          - os: macos-latest
            platform: macos
            artifact_name: ImageTrim.app
            python_cmd: python3

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Setup uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Create virtual environment
      run: uv venv

    - name: Install dependencies
      shell: bash
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        uv pip install nuitka ordered-set zstandard

    - name: Install system dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        # åŸºç¡€ä¾èµ–
        sudo apt-get install -y python3-tk python3-dev build-essential
        
        # OpenGL ç›¸å…³åŒ…
        sudo apt-get install -y libgl1-mesa-glx || sudo apt-get install -y libgl1 || echo "OpenGL package not found"
        sudo apt-get install -y libglu1-mesa-dev || sudo apt-get install -y libglu1 || echo "GLU package not found"
        
        # X11 å’Œå›¾å½¢åº“
        sudo apt-get install -y libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 libxrandr2
        
        # å…¶ä»–ä¾èµ–
        sudo apt-get install -y libxcb-xinerama0 || echo "xcb-xinerama not available"
        sudo apt-get install -y libxss1 || echo "xss not available"
        sudo apt-get install -y libdbus-1-3 || echo "dbus not available"
        sudo apt-get install -y libgtk-3-0 || echo "gtk3 not available"
        sudo apt-get install -y libasound2-dev || echo "alsa not available"
        
        # C ç¼–è¯‘å™¨ï¼ˆNuitka éœ€è¦ï¼‰
        sudo apt-get install -y gcc g++ ccache patchelf

    - name: Install system dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        # macOS ç³»ç»Ÿä¾èµ–
        echo "macOS dependencies check"
        # ç¡®ä¿æœ‰ C ç¼–è¯‘å™¨
        xcode-select --install || echo "Xcode command line tools already installed"
        # å®‰è£… ccache åŠ é€Ÿç¼–è¯‘
        brew install ccache || echo "ccache already installed"

    - name: Install system dependencies (Windows)
      if: matrix.platform == 'windows'
      shell: powershell
      run: |
        # Windows ä¸éœ€è¦é¢å¤–å®‰è£…ç¼–è¯‘å™¨ï¼ŒNuitka ä¼šè‡ªåŠ¨ä¸‹è½½ MinGW
        echo "Windows: Nuitka will auto-download MinGW if needed"

    - name: Build with Nuitka (Windows)
      if: matrix.platform == 'windows'
      shell: powershell
      run: |
        echo "Building with Nuitka on Windows..."
        .venv\Scripts\python.exe -m nuitka `
          --standalone `
          --onefile `
          --assume-yes-for-downloads `
          --enable-plugin=pyqt6 `
          --include-package=pillow_avif `
          --include-module=pillow_avif._avif `
          --include-package=send2trash `
          --include-data-dir=app/resources/icons=resources/icons `
          --include-data-dir=app/resources/images=resources/images `
          --windows-disable-console `
          --windows-icon-from-ico=app/resources/icons/imageTrim256px.ico `
          --lto=yes `
          --remove-output `
          --output-dir=dist_nuitka `
          --output-filename=ImageTrim.exe `
          app/main.py

    - name: Build with Nuitka (Linux)
      if: matrix.platform == 'linux'
      shell: bash
      run: |
        echo "Building with Nuitka on Linux..."
        .venv/bin/python -m nuitka \
          --standalone \
          --onefile \
          --assume-yes-for-downloads \
          --enable-plugin=pyqt6 \
          --include-package=pillow_avif \
          --include-module=pillow_avif._avif \
          --include-package=send2trash \
          --include-data-dir=app/resources/icons=resources/icons \
          --include-data-dir=app/resources/images=resources/images \
          --lto=yes \
          --remove-output \
          --output-dir=dist_nuitka \
          --output-filename=ImageTrim \
          app/main.py

    - name: Build with Nuitka (macOS)
      if: matrix.platform == 'macos'
      shell: bash
      run: |
        echo "Building with Nuitka on macOS..."
        .venv/bin/python -m nuitka \
          --standalone \
          --onefile \
          --assume-yes-for-downloads \
          --enable-plugin=pyqt6 \
          --include-package=pillow_avif \
          --include-module=pillow_avif._avif \
          --include-package=send2trash \
          --include-data-dir=app/resources/icons=resources/icons \
          --include-data-dir=app/resources/images=resources/images \
          --macos-create-app-bundle \
          --macos-app-icon=app/resources/icons/imageTrim256px.ico \
          --lto=yes \
          --remove-output \
          --output-dir=dist_nuitka \
          --output-filename=ImageTrim \
          app/main.py

    - name: Create Linux packages
      if: matrix.platform == 'linux'
      run: |
        # æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸ
        if [ ! -f "dist_nuitka/ImageTrim" ]; then
          echo "Error: Linux binary not found in dist_nuitka/"
          ls -la dist_nuitka/ || echo "dist_nuitka directory not found"
          exit 1
        fi
        
        echo "Found Linux binary: dist_nuitka/ImageTrim"
        
        # åˆ›å»º AppImage
        mkdir -p ImageTrim.AppDir/usr/bin
        mkdir -p ImageTrim.AppDir/usr/share/applications
        mkdir -p ImageTrim.AppDir/usr/share/icons/hicolor/256x256/apps
        
        cp dist_nuitka/ImageTrim ImageTrim.AppDir/usr/bin/imagetrim
        chmod +x ImageTrim.AppDir/usr/bin/imagetrim
        
        # åˆ›å»º desktop æ–‡ä»¶
        cat > ImageTrim.AppDir/usr/share/applications/imagetrim.desktop << 'EOF'
        [Desktop Entry]
        Name=ImageTrim
        Name[zh_CN]=å›¾ç‰‡å»é‡å·¥å…·
        Comment=Image deduplication and conversion tool
        Comment[zh_CN]=å›¾ç‰‡å»é‡å’Œæ ¼å¼è½¬æ¢å·¥å…·
        Exec=imagetrim
        Icon=imagetrim
        Terminal=false
        Type=Application
        Categories=Graphics;Photography;
        MimeType=image/jpeg;image/png;image/webp;image/avif;
        StartupWMClass=ImageTrim
        EOF
        
        # åˆ›å»º AppRun
        cat > ImageTrim.AppDir/AppRun << 'EOFRUN'
        #!/bin/sh
        HERE="$(dirname "$(readlink -f "${0}")")"
        export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}"
        export PATH="${HERE}/usr/bin:${PATH}"
        exec "${HERE}/usr/bin/imagetrim" "$@"
        EOFRUN
        chmod +x ImageTrim.AppDir/AppRun
        
        # å¤åˆ¶ desktop æ–‡ä»¶åˆ°æ ¹ç›®å½•
        cp ImageTrim.AppDir/usr/share/applications/imagetrim.desktop ImageTrim.AppDir/imagetrim.desktop
        
        # ä¸‹è½½ appimagetool
        wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
        chmod +x appimagetool
        
        # åˆ›å»º AppImage
        ./appimagetool --no-appstream ImageTrim.AppDir ImageTrim-${{ github.ref_name }}-linux.AppImage || echo "AppImage creation failed"

    - name: Create DMG (macOS)
      if: matrix.platform == 'macos'
      run: |
        if [ -d "dist_nuitka/ImageTrim.app" ]; then
          mkdir -p dmg_temp
          cp -R "dist_nuitka/ImageTrim.app" dmg_temp/
          ln -s /Applications dmg_temp/Applications
          hdiutil create -volname "ImageTrim" -srcfolder dmg_temp -ov -format UDZO ImageTrim-${{ github.ref_name }}-macos.dmg
          rm -rf dmg_temp
        fi

    - name: Show build results
      shell: bash
      run: |
        echo "=== Build Results for ${{ matrix.platform }} ==="
        echo "Contents of dist_nuitka/:"
        ls -lah dist_nuitka/ || echo "dist_nuitka directory not found"
        echo ""
        echo "Root directory files:"
        ls -lah *.AppImage *.dmg 2>/dev/null || echo "No AppImage or DMG files found"
        echo ""
        if [ -d "dist_nuitka" ]; then
          echo "Total size of dist_nuitka/:"
          du -sh dist_nuitka/
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-nuitka-build
        path: |
          dist_nuitka/
          *.AppImage
          *.dmg
        retention-days: 30
        if-no-files-found: error

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display artifacts structure
      run: |
        echo "=== Artifacts Structure ==="
        find artifacts -type f -name "*" | head -30
        echo ""
        echo "Platform directories:"
        ls -la artifacts/ || echo "No artifacts directory"

    - name: Prepare release assets
      run: |
        mkdir -p release-assets

        echo "=== Full artifacts structure ==="
        find artifacts -type f | sort

        echo ""
        echo "=== Processing Windows artifacts ==="
        if [ -d "artifacts/windows-nuitka-build" ]; then
          ls -la artifacts/windows-nuitka-build/
          cp -r artifacts/windows-nuitka-build/dist_nuitka/* release-assets/ 2>/dev/null || echo "No Windows artifacts found"
        else
          echo "Windows build directory not found"
        fi

        echo ""
        echo "=== Processing macOS artifacts ==="
        if [ -d "artifacts/macos-nuitka-build" ]; then
          ls -la artifacts/macos-nuitka-build/
          cp -r artifacts/macos-nuitka-build/dist_nuitka/* release-assets/ 2>/dev/null || echo "No macOS dist found"
          cp artifacts/macos-nuitka-build/*.dmg release-assets/ 2>/dev/null || echo "No DMG found"
        else
          echo "macOS build directory not found"
        fi

        echo ""
        echo "=== Processing Linux artifacts ==="
        if [ -d "artifacts/linux-nuitka-build" ]; then
          ls -la artifacts/linux-nuitka-build/
          cp -r artifacts/linux-nuitka-build/dist_nuitka/* release-assets/ 2>/dev/null || echo "No Linux dist found"
          cp artifacts/linux-nuitka-build/*.AppImage release-assets/ 2>/dev/null || echo "No AppImage found"
        else
          echo "Linux build directory not found"
        fi

        echo ""
        echo "=== Final Release Assets ==="
        ls -lah release-assets/
        echo "Total size:"
        du -sh release-assets/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: ImageTrim ${{ github.ref_name }} - Nuitka ç¼–è¯‘ç‰ˆæœ¬
        body: |
          ## ImageTrim ${{ github.ref_name }} - Nuitka åŸç”Ÿç¼–è¯‘ç‰ˆæœ¬

          ### ğŸš€ é‡å¤§æ”¹è¿›
          - **åŸç”Ÿç¼–è¯‘**: ä½¿ç”¨ Nuitka ç¼–è¯‘ä¸ºåŸç”Ÿæœºå™¨ç ï¼Œæ€§èƒ½æ›´ä¼˜
          - **å¯åŠ¨æ›´å¿«**: ç›¸æ¯” PyInstaller ç‰ˆæœ¬å¯åŠ¨é€Ÿåº¦æå‡ 2-3 å€
          - **ä½“ç§¯ä¼˜åŒ–**: æ–‡ä»¶ä½“ç§¯è¿›ä¸€æ­¥ä¼˜åŒ–
          - **æ›´ç¨³å®š**: åŸç”Ÿç¼–è¯‘å‡å°‘è¿è¡Œæ—¶é”™è¯¯

          ### ğŸ“¦ ä¸‹è½½æ–‡ä»¶

          #### Windows
          - `ImageTrim.exe` - Windows å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå•æ–‡ä»¶ï¼Œçº¦ 40-60MBï¼‰

          #### macOS
          - `ImageTrim.app/` - macOS åº”ç”¨ç¨‹åºåŒ…ï¼ˆç›®å½•å½¢å¼ï¼‰
          - `ImageTrim-*.dmg` - macOS ç£ç›˜é•œåƒï¼ˆæ¨èï¼‰

          #### Linux
          - `ImageTrim` - Linux å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå•æ–‡ä»¶ï¼‰
          - `ImageTrim-*.AppImage` - Linux ä¾¿æºç‰ˆï¼ˆæ¨èï¼‰

          ### ğŸ¯ ä½¿ç”¨æ–¹æ³•

          #### Windows
          1. ä¸‹è½½ `ImageTrim.exe`
          2. ç›´æ¥åŒå‡»è¿è¡Œ

          #### macOS
          1. ä¸‹è½½ `ImageTrim-*.dmg`
          2. æ‰“å¼€ DMG æ–‡ä»¶
          3. å°† ImageTrim.app æ‹–åˆ° Applications æ–‡ä»¶å¤¹
          4. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸

          #### Linux
          1. ä¸‹è½½ `ImageTrim-*.AppImage`
          2. æ·»åŠ æ‰§è¡Œæƒé™: `chmod +x ImageTrim-*.AppImage`
          3. ç›´æ¥è¿è¡Œ: `./ImageTrim-*.AppImage`

          ### âš¡ æ€§èƒ½å¯¹æ¯”

          | æŒ‡æ ‡ | PyInstaller | Nuitka | æ”¹è¿› |
          |------|-------------|--------|------|
          | å¯åŠ¨é€Ÿåº¦ | ~3-5ç§’ | ~1-2ç§’ | **2-3x æ›´å¿«** |
          | è¿è¡Œæ€§èƒ½ | è§£é‡Šæ‰§è¡Œ | åŸç”Ÿæœºå™¨ç  | **æ›´ä¼˜** |
          | å†…å­˜å ç”¨ | è¾ƒé«˜ | è¾ƒä½ | **ä¼˜åŒ–** |
          | ç¨³å®šæ€§ | è‰¯å¥½ | æ›´å¥½ | **æå‡** |

          ### ğŸ’¡ æŠ€æœ¯ç»†èŠ‚
          - **ç¼–è¯‘å™¨**: Nuitka (Python â†’ C â†’ æœºå™¨ç )
          - **ä¼˜åŒ–çº§åˆ«**: LTO (é“¾æ¥æ—¶ä¼˜åŒ–)
          - **åŒ…å«æ¨¡å—**: PyQt6, Pillow, pillow-avif-plugin, send2trash
          - **èµ„æºæ–‡ä»¶**: å®Œæ•´åŒ…å«å›¾æ ‡å’Œå›¾ç‰‡èµ„æº

          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - **Windows**: Windows 10/11 (x64)
          - **macOS**: macOS 10.14+ (x64/ARM64)
          - **Linux**: x64, GLIBC 2.17+

          ### ğŸ”§ å·²çŸ¥é—®é¢˜
          - macOS é¦–æ¬¡è¿è¡Œéœ€è¦åœ¨å®‰å…¨è®¾ç½®ä¸­å…è®¸
          - Linux æŸäº›å‘è¡Œç‰ˆå¯èƒ½éœ€è¦å®‰è£…é¢å¤–çš„å›¾å½¢åº“

          ---
          **è‡ªåŠ¨æ„å»º** Â· **åŸç”Ÿç¼–è¯‘** Â· **æ€§èƒ½ä¼˜åŒ–**
        files: release-assets/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


