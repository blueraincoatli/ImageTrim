# PyQt6重构技术方案文档

## 1. 项目概述

### 1.1 项目背景
本项目旨在将现有的基于ttkbootstrap/tkinter的图片处理工具套件重构为基于PyQt6的现代化桌面应用。在保持现有业务逻辑的基础上，通过PyQt6重构实现更现代化、高性能的用户界面，同时保持开源友好性。

### 1.2 重构目标
1. **UI框架升级**：从ttkbootstrap/tkinter迁移到PyQt6
2. **高DPI支持**：完善高DPI适配，提升在不同分辨率屏幕上的显示效果
3. **现代化设计**：实现统一的UI/UX设计规范，提升用户体验
4. **架构优化**：进一步解耦UI和业务逻辑，提高代码可维护性
5. **性能提升**：利用PyQt6的特性优化应用性能

## 2. 系统架构设计

### 2.1 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                    主应用窗口 (QMainWindow)                  │
├─────────────────────────────────────────────────────────────┤
│  左栏功能选择  │  中栏设置与进度  │  右栏工作区              │
├─────────────────────────────────────────────────────────────┤
│  FunctionManager  │  PyQt6信号槽机制  │  动态UI加载          │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块划分
1. **核心模块**
   - `main.py`：程序入口和主窗口
   - `core/function_manager.py`：功能模块管理器
   - `core/base_module.py`：功能模块基类

2. **UI模块**
   - `ui/main_window.py`：主窗口实现
   - `ui/function_panel.py`：左栏功能选择面板
   - `ui/settings_panel.py`：中栏设置面板
   - `ui/workspace_panel.py`：右栏工作区面板
   - `ui/theme_manager.py`：主题管理器
   - `ui/high_dpi_manager.py`：高DPI管理器

3. **功能模块**
   - `modules/deduplication/`：图片去重模块
   - `modules/avif_converter/`：AVIF转换模块

4. **工具模块**
   - `utils/image_utils.py`：图片处理工具
   - `utils/ui_components.py`：通用UI组件
   - `utils/threading.py`：多线程处理工具

## 3. 核心逻辑设计

### 3.1 插件化架构
```python
# 核心接口定义
class BaseFunctionModule(QObject, ABC):
    # 信号定义
    progress_updated = pyqtSignal(float, str)  # 进度更新
    log_message = pyqtSignal(str, str)         # 日志消息
    execution_finished = pyqtSignal(dict)      # 执行完成
    
    @abstractmethod
    def create_settings_ui(self) -> QWidget:
        """创建设置UI面板"""
        pass
        
    @abstractmethod
    def create_workspace_ui(self) -> QWidget:
        """创建工作区UI面板"""
        pass
        
    @abstractmethod
    def execute(self, params: dict):
        """执行功能核心逻辑"""
        pass
        
    @abstractmethod
    def stop_execution(self):
        """停止执行"""
        pass
```

### 3.2 功能管理器
```python
class FunctionManager(QObject):
    module_activated = pyqtSignal(str)  # 模块激活信号
    
    def __init__(self):
        self.modules: Dict[str, BaseFunctionModule] = {}
        self.active_module: Optional[BaseFunctionModule] = None
        
    def register_module(self, module: BaseFunctionModule):
        """注册功能模块"""
        
    def activate_module(self, name: str) -> bool:
        """激活指定功能模块"""
```

### 3.3 多线程处理
```python
class WorkerThread(QThread):
    progress_updated = pyqtSignal(int, str)
    log_message = pyqtSignal(str, str)
    finished = pyqtSignal(dict)
    
    def run(self):
        """执行耗时操作"""
        pass
```

## 4. 技术选型

### 4.1 核心框架
- **GUI框架**：PyQt6
- **图片处理**：Pillow/PIL
- **数值计算**：NumPy
- **哈希计算**：imagehash
- **打包工具**：PyInstaller

### 4.2 UI设计
- **布局管理**：QMainWindow + QSplitter
- **样式系统**：QSS (Qt Style Sheets)
- **高DPI支持**：Qt内置高DPI适配
- **主题管理**：自定义主题管理器

### 4.3 性能优化
- **多线程**：QThread处理耗时操作
- **信号槽机制**：替代回调机制
- **资源管理**：合理的内存管理和资源释放

## 5. 迁移策略

### 5.1 渐进式迁移
1. **第一阶段**：搭建PyQt6基础框架
2. **第二阶段**：重构UI组件
3. **第三阶段**：适配功能模块
4. **第四阶段**：优化和完善

### 5.2 兼容性保证
- 保持现有业务逻辑不变
- 逐步替换UI层实现
- 提供充分的测试验证

## 6. 风险评估

### 6.1 技术风险
1. **PyQt6学习曲线**：团队需要时间熟悉PyQt6
2. **性能问题**：PyQt6可能比tkinter消耗更多资源
3. **兼容性问题**：不同平台可能存在显示差异

### 6.2 项目风险
1. **进度延期**：重构工作量大可能导致延期
2. **功能缺失**：重构过程中可能遗漏某些功能
3. **用户体验下降**：新界面可能不如预期

## 7. 质量保证

### 7.1 代码质量
- 遵循PEP 8规范
- 使用类型提示
- 实施代码审查机制

### 7.2 用户体验
- 进行用户测试
- 收集反馈并改进
- 持续优化体验

### 7.3 性能优化
- 建立性能基准
- 及时释放资源
- 优化图片加载和显示