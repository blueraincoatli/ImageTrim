# ImageTrim ä»£ç å¼€å‘è§„èŒƒ

## ğŸ“‹ æ¦‚è§ˆ

æœ¬æ–‡æ¡£å®šä¹‰äº†ImageTrimé¡¹ç›®çš„ä»£ç å¼€å‘è§„èŒƒï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œä¸€è‡´æ€§ã€‚æ‰€æœ‰å¼€å‘è€…éƒ½åº”è¯¥éµå¾ªè¿™äº›è§„èŒƒã€‚

## 1. ğŸ·ï¸ å‘½åè§„èŒƒ

### 1.1 æ–‡ä»¶å‘½å
- **Pythonæ–‡ä»¶**: ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿å‘½åï¼Œå¦‚ `image_utils.py`
- **æ¨¡å—æ–‡ä»¶**: åŠŸèƒ½æ¨¡å—ç»Ÿä¸€ä½¿ç”¨ `module.py`ï¼Œå¦‚ `deduplication/module.py`
- **UIæ–‡ä»¶**: ç•Œé¢ç»„ä»¶ä½¿ç”¨ `ui.py`ï¼Œå¦‚ `deduplication/ui.py`
- **é€»è¾‘æ–‡ä»¶**: ä¸šåŠ¡é€»è¾‘ä½¿ç”¨ `logic.py`ï¼Œå¦‚ `deduplication/logic.py`

### 1.2 ç±»å‘½å
- **åŸºç±»**: æŠ½è±¡åŸºç±»ä»¥ `Base` å¼€å¤´ï¼Œå¦‚ `BaseFunctionModule`
- **åŠŸèƒ½ç±»**: æ¨¡å—ç±»ä»¥åŠŸèƒ½å‘½åï¼Œå¦‚ `DeduplicationModule`
- **UIç±»**: PyQtç»„ä»¶ç±»ä»¥ `Widget`ã€`Dialog`æˆ–`Panel`ç»“å°¾ï¼Œå¦‚ `SettingsWidget`
- **å¼‚å¸¸ç±»**: ä»¥ `Error` æˆ– `Exception` ç»“å°¾ï¼Œå¦‚ `ModuleNotFoundError`

### 1.3 å‡½æ•°å‘½å
- **å…¬å…±å‡½æ•°**: ä½¿ç”¨åŠ¨è¯å¼€å¤´ï¼Œå¦‚ `calculate_hash`, `load_image`
- **ç§æœ‰å‡½æ•°**: ä»¥ä¸‹åˆ’çº¿å¼€å¤´ï¼Œå¦‚ `_process_file`
- **å±æ€§è®¿é—®å™¨**: ä½¿ç”¨ `get_` å’Œ `set_` å‰ç¼€ï¼Œå¦‚ `get_file_info`
- **äº‹ä»¶å¤„ç†**: ä½¿ç”¨ `on_` å‰ç¼€ï¼Œå¦‚ `on_button_click`

## 2. ğŸ“ ä»£ç æ ¼å¼

### 2.1 ç¼©è¿›å’Œç©ºæ ¼
- ä½¿ç”¨**4ä¸ªç©ºæ ¼**è¿›è¡Œç¼©è¿›ï¼Œä¸ä½¿ç”¨Tab
- æ“ä½œç¬¦ä¸¤ä¾§æ·»åŠ ç©ºæ ¼ï¼Œå¦‚ `a = b + c`
- é€—å·åæ·»åŠ ç©ºæ ¼ï¼Œå¦‚ `func(a, b, c)`
- å‡½æ•°å®šä¹‰å’Œè°ƒç”¨æ—¶å‚æ•°åˆ—è¡¨çš„æ‹¬å·å†…ä¾§ä¸åŠ ç©ºæ ¼

### 2.2 è¡Œé•¿åº¦
- æ¯è¡Œä¸è¶…è¿‡**88ä¸ªå­—ç¬¦**ï¼ˆå…¼å®¹blackæ ¼å¼åŒ–å·¥å…·ï¼‰
- é•¿è¡¨è¾¾å¼ä½¿ç”¨æ‹¬å·æ¢è¡Œï¼Œä¿æŒä¸€è‡´çš„ç¼©è¿›
- å­—ç¬¦ä¸²æ‹¼æ¥ä½¿ç”¨æ‹¬å·è€Œéåæ–œæ 

### 2.3 ç©ºè¡Œè§„èŒƒ
- **æ¨¡å—çº§åˆ«**: ç±»å®šä¹‰å‰åå„ç©ºä¸¤è¡Œ
- **ç±»çº§åˆ«**: æ–¹æ³•å®šä¹‰å‰åå„ç©ºä¸€è¡Œ
- **é€»è¾‘åˆ†ç»„**: ç›¸å…³åŠŸèƒ½çš„ä»£ç å—ä¹‹é—´ç©ºä¸€è¡Œ
- **é¿å…è¿‡åº¦ç©ºè¡Œ**: ä¸è¦æœ‰è¿ç»­çš„ç©ºè¡Œ

## 3. ğŸ”§ ç±»å‹æç¤º

### 3.1 å‡½æ•°ç±»å‹æç¤º
**å¿…é¡»ä¸ºæ‰€æœ‰å…¬å…±å‡½æ•°æ·»åŠ ç±»å‹æç¤º**ï¼š
```python
from typing import List, Dict, Optional, Any
from PyQt6.QtCore import pyqtSignal

def calculate_similarity(file1: str, file2: str) -> float:
    """è®¡ç®—ä¸¤ä¸ªæ–‡ä»¶çš„ç›¸ä¼¼åº¦"""
    pass

def process_files(files: List[str]) -> Dict[str, Any]:
    """å¤„ç†æ–‡ä»¶åˆ—è¡¨"""
    pass

# PyQt6ä¿¡å·ä¹Ÿè¦æœ‰ç±»å‹æç¤º
class WorkerSignals(QObject):
    finished = pyqtSignal()  # æ— å‚æ•°ä¿¡å·
    progress_updated = pyqtSignal(int, str)  # å¸¦å‚æ•°ä¿¡å·
```

### 3.2 å˜é‡ç±»å‹æç¤º
**é‡è¦å˜é‡å’Œç±»å±æ€§åº”è¯¥æ·»åŠ ç±»å‹æç¤º**ï¼š
```python
from typing import List, Dict, Optional, Any
from PyQt6.QtGui import QPixmap

file_path: str = "/path/to/file"
file_list: List[str] = []
result: Optional[Dict[str, Any]] = None
thumbnail_cache: Dict[str, QPixmap] = {}
```

## 4. ğŸ“š æ–‡æ¡£å­—ç¬¦ä¸²

### 4.1 æ¨¡å—æ–‡æ¡£å­—ç¬¦ä¸²
**æ¯ä¸ªæ¨¡å—éƒ½åº”è¯¥æœ‰è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²**ï¼š
```python
"""
å›¾ç‰‡å»é‡æ¨¡å—

æä¾›åŸºäºå›¾åƒå“ˆå¸Œç®—æ³•çš„å›¾ç‰‡ç›¸ä¼¼åº¦æ£€æµ‹å’Œå»é‡åŠŸèƒ½ã€‚
æ”¯æŒå¤šç§å“ˆå¸Œç®—æ³•ï¼ŒåŒ…æ‹¬æ„ŸçŸ¥å“ˆå¸Œã€å·®å¼‚å“ˆå¸Œå’Œå°æ³¢å“ˆå¸Œã€‚

ä¸»è¦åŠŸèƒ½:
- å›¾ç‰‡ç›¸ä¼¼åº¦è®¡ç®—
- é‡å¤å›¾ç‰‡æ£€æµ‹
- æ‰¹é‡å¤„ç†æ”¯æŒ
- å¯é…ç½®çš„ç›¸ä¼¼åº¦é˜ˆå€¼

ä½œè€…: ImageTrim Team
åˆ›å»ºæ—¥æœŸ: 2025-10-12
ç‰ˆæœ¬: 1.0.0

ä¾èµ–:
    - PIL (Pillow)
    - imagehash
    - numpy
"""
```

### 4.2 ç±»æ–‡æ¡£å­—ç¬¦ä¸²
**ç±»çš„æ–‡æ¡£å­—ç¬¦ä¸²åº”åŒ…å«ç”¨é€”ã€å±æ€§å’Œæ–¹æ³•è¯´æ˜**ï¼š
```python
class DeduplicationModule(BaseFunctionModule):
    """
    å›¾ç‰‡å»é‡åŠŸèƒ½æ¨¡å—

    å®ç°åŸºäºå›¾åƒå“ˆå¸Œç®—æ³•çš„å›¾ç‰‡å»é‡åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§å“ˆå¸Œç®—æ³•
    å’Œå¯é…ç½®çš„ç›¸ä¼¼åº¦é˜ˆå€¼ã€‚æä¾›å®Œæ•´çš„UIç•Œé¢å’Œåå°å¤„ç†é€»è¾‘ã€‚

    ç»§æ‰¿è‡ª:
        BaseFunctionModule: åŠŸèƒ½æ¨¡å—åŸºç±»

    å±æ€§:
        similarity_threshold (float): ç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œé»˜è®¤0.85
        hash_algorithm (str): å“ˆå¸Œç®—æ³•ç±»å‹ï¼Œé»˜è®¤'average'
        min_file_size (int): æœ€å°æ–‡ä»¶å¤§å°(å­—èŠ‚)ï¼Œé»˜è®¤1024

    ä¿¡å·:
        progress_updated: è¿›åº¦æ›´æ–°ä¿¡å·
        scan_completed: æ‰«æå®Œæˆä¿¡å·
        duplicates_found: å‘ç°é‡å¤é¡¹ä¿¡å·
    """
```

### 4.3 å‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸²
**å‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸²åº”åŒ…å«å‚æ•°ã€è¿”å›å€¼å’Œå¼‚å¸¸è¯´æ˜**ï¼š
```python
def calculate_image_hash(self, file_path: str, hash_type: str = "average") -> str:
    """
    è®¡ç®—å›¾ç‰‡çš„å“ˆå¸Œå€¼

    ä½¿ç”¨æŒ‡å®šçš„å“ˆå¸Œç®—æ³•è®¡ç®—å›¾ç‰‡æ–‡ä»¶çš„å“ˆå¸Œå€¼ï¼Œç”¨äºç›¸ä¼¼åº¦æ¯”è¾ƒã€‚

    Args:
        file_path (str): å›¾ç‰‡æ–‡ä»¶è·¯å¾„
        hash_type (str, optional): å“ˆå¸Œç®—æ³•ç±»å‹
            å¯é€‰å€¼: 'average', 'difference', 'wavelet'
            é»˜è®¤å€¼: 'average'

    Returns:
        str: å›¾ç‰‡çš„å“ˆå¸Œå€¼å­—ç¬¦ä¸²

    Raises:
        FileNotFoundError: æ–‡ä»¶ä¸å­˜åœ¨æ—¶æŠ›å‡º
        PIL.UnidentifiedImageError: æ— æ³•è¯†åˆ«çš„å›¾ç‰‡æ ¼å¼
        ValueError: ä¸æ”¯æŒçš„å“ˆå¸Œç®—æ³•ç±»å‹
        MemoryError: å›¾ç‰‡å¤ªå¤§å¯¼è‡´å†…å­˜ä¸è¶³

    ç¤ºä¾‹:
        >>> hash_value = calculate_image_hash("test.jpg", "average")
        >>> print(len(hash_value))
        64
    """
```

## 5. é”™è¯¯å¤„ç†

### 5.1 å¼‚å¸¸å¤„ç†åŸåˆ™
- ä¼˜å…ˆä½¿ç”¨å…·ä½“çš„å¼‚å¸¸ç±»å‹ï¼Œè€Œä¸æ˜¯é€šç”¨çš„ `Exception`
- æä¾›æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯
- é¿å…å¿½ç•¥å¼‚å¸¸ï¼ˆç©ºçš„exceptå—ï¼‰

### 5.2 å¼‚å¸¸å¤„ç†ç¤ºä¾‹
```python
try:
    with open(file_path, 'rb') as f:
        # å¤„ç†æ–‡ä»¶
        pass
except FileNotFoundError:
    logger.error(f"æ–‡ä»¶æœªæ‰¾åˆ°: {file_path}")
    raise
except IOError as e:
    logger.error(f"æ–‡ä»¶è¯»å–é”™è¯¯: {file_path}, {str(e)}")
    raise
```

## 6. æ—¥å¿—è®°å½•

### 6.1 æ—¥å¿—çº§åˆ«ä½¿ç”¨
- `DEBUG`: è¯¦ç»†ä¿¡æ¯ï¼Œé€šå¸¸åªåœ¨è¯Šæ–­é—®é¢˜æ—¶ä½¿ç”¨
- `INFO`: ç¡®è®¤äº‹æƒ…æŒ‰é¢„æœŸå·¥ä½œ
- `WARNING`: è¡¨ç¤ºå‘ç”Ÿäº†æ„å¤–æƒ…å†µï¼Œä½†ç¨‹åºä»èƒ½æ­£å¸¸å·¥ä½œ
- `ERROR`: ç”±äºä¸¥é‡é—®é¢˜ï¼Œç¨‹åºçš„æŸäº›åŠŸèƒ½æ— æ³•æ‰§è¡Œ
- `CRITICAL`: ä¸¥é‡é”™è¯¯ï¼Œç¨‹åºå¯èƒ½æ— æ³•ç»§ç»­è¿è¡Œ

### 6.2 æ—¥å¿—è®°å½•ç¤ºä¾‹
```python
import logging

logger = logging.getLogger(__name__)

def process_image(file_path: str):
    logger.info(f"å¼€å§‹å¤„ç†å›¾ç‰‡: {file_path}")
    try:
        # å¤„ç†é€»è¾‘
        pass
    except Exception as e:
        logger.error(f"å¤„ç†å›¾ç‰‡å¤±è´¥: {file_path}, é”™è¯¯: {str(e)}")
        raise
```

## 7. PyQt6ç‰¹å®šè§„èŒƒ

### 7.1 ä¿¡å·å’Œæ§½
```python
class Worker(QObject):
    # ä¿¡å·å‘½åä½¿ç”¨è¿‡å»å¼åŠ¨è¯
    finished = pyqtSignal()
    progress_updated = pyqtSignal(int, str)
    
    def do_work(self):
        # æ§½å‡½æ•°å‘½åä½¿ç”¨åŠ¨è¯åŸå½¢
        pass
```

### 7.2 èµ„æºç®¡ç†
```python
class ImageWidget(QWidget):
    def __init__(self):
        super().__init__()
        self._pixmaps = {}  # ç¼“å­˜Pixmapå¯¹è±¡
        
    def __del__(self):
        # æ¸…ç†èµ„æº
        self._pixmaps.clear()
```

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 é¿å…é‡å¤è®¡ç®—
```python
class ImageCache:
    def __init__(self):
        self._cache = {}
        self._cache_time = {}
        
    def get_thumbnail(self, file_path: str) -> QPixmap:
        # ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤è®¡ç®—
        if file_path in self._cache:
            return self._cache[file_path]
        # è®¡ç®—å¹¶ç¼“å­˜
```

### 8.2 åˆç†ä½¿ç”¨å¤šçº¿ç¨‹
```python
class WorkerThread(QThread):
    def run(self):
        # è€—æ—¶æ“ä½œåœ¨åå°çº¿ç¨‹æ‰§è¡Œ
        # é€šè¿‡ä¿¡å·ä¸ä¸»çº¿ç¨‹é€šä¿¡
        pass
```

## 9. æµ‹è¯•è§„èŒƒ

### 9.1 å•å…ƒæµ‹è¯•
- æ¯ä¸ªæ¨¡å—éƒ½åº”è¯¥æœ‰å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶
- æµ‹è¯•æ–‡ä»¶å‘½åä»¥ `test_` å¼€å¤´ï¼Œå¦‚ `test_image_utils.py`
- ä½¿ç”¨pytestæ¡†æ¶ç¼–å†™æµ‹è¯•

### 9.2 æµ‹è¯•ç¤ºä¾‹
```python
def test_calculate_similarity():
    """æµ‹è¯•ç›¸ä¼¼åº¦è®¡ç®—åŠŸèƒ½"""
    file1 = "test1.jpg"
    file2 = "test2.jpg"
    similarity = calculate_similarity(file1, file2)
    assert 0 <= similarity <= 1
```

## 10. ä»£ç å®¡æŸ¥è¦ç‚¹

### 10.1 å®¡æŸ¥æ¸…å•
- [ ] å‘½åæ˜¯å¦ç¬¦åˆè§„èŒƒ
- [ ] æ˜¯å¦æœ‰é€‚å½“çš„ç±»å‹æç¤º
- [ ] æ–‡æ¡£å­—ç¬¦ä¸²æ˜¯å¦å®Œæ•´
- [ ] é”™è¯¯å¤„ç†æ˜¯å¦æ°å½“
- [ ] æ—¥å¿—è®°å½•æ˜¯å¦åˆç†
- [ ] èµ„æºæ˜¯å¦æ­£ç¡®é‡Šæ”¾
- [ ] æ€§èƒ½æ˜¯å¦æœ‰ä¼˜åŒ–ç©ºé—´
- [ ] æ˜¯å¦æœ‰å¯¹åº”çš„å•å…ƒæµ‹è¯•