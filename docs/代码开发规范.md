# 代码开发规范

## 1. 命名规范

### 1.1 文件命名
- Python文件使用小写字母和下划线命名，如 `image_utils.py`
- 类名使用驼峰命名法，如 `ImageProcessor`
- 函数和变量使用下划线命名法，如 `calculate_similarity`

### 1.2 类命名
- 抽象基类以 `Base` 开头，如 `BaseFunctionModule`
- 异常类以 `Error` 或 `Exception` 结尾，如 `ModuleNotFoundError`
- PyQt组件类以 `Widget` 或 `Dialog` 结尾，如 `SettingsWidget`

### 1.3 函数命名
- 公共函数使用动词开头，如 `calculate_hash`, `load_image`
- 私有函数以下划线开头，如 `_process_file`
- 属性访问器使用 `get_` 和 `set_` 前缀，如 `get_file_info`

## 2. 代码格式

### 2.1 缩进和空格
- 使用4个空格进行缩进，不使用Tab
- 操作符两侧添加空格，如 `a = b + c`
- 逗号后添加空格，如 `func(a, b, c)`

### 2.2 行长度
- 每行不超过88个字符（兼容black格式化工具）
- 长表达式使用括号换行，保持一致的缩进

### 2.3 空行
- 类定义前后各空两行
- 函数定义前后各空一行
- 逻辑段落之间空一行

## 3. 类型提示

### 3.1 函数类型提示
```python
def calculate_similarity(file1: str, file2: str) -> float:
    """计算两个文件的相似度"""
    pass

def process_files(files: List[str]) -> Dict[str, Any]:
    """处理文件列表"""
    pass
```

### 3.2 变量类型提示
```python
file_path: str = "/path/to/file"
file_list: List[str] = []
result: Optional[Dict[str, Any]] = None
```

## 4. 文档字符串

### 4.1 模块文档字符串
```python
"""
图片处理工具模块

本模块提供了图片处理相关的功能，包括相似度计算、
哈希值计算等核心功能。

作者: Your Name
日期: 2025-09-26
"""
```

### 4.2 类文档字符串
```python
class ImageProcessor:
    """
    图片处理器类
    
    用于处理图片相关的操作，包括相似度计算、格式转换等。
    
    属性:
        quality: 转换质量
        format: 目标格式
    """
```

### 4.3 函数文档字符串
```python
def calculate_hash(file_path: str) -> str:
    """
    计算文件的哈希值
    
    Args:
        file_path: 文件路径
        
    Returns:
        str: 文件的MD5哈希值
        
    Raises:
        FileNotFoundError: 文件不存在
        IOError: 文件读取错误
    """
```

## 5. 错误处理

### 5.1 异常处理原则
- 优先使用具体的异常类型，而不是通用的 `Exception`
- 提供有意义的错误信息
- 避免忽略异常（空的except块）

### 5.2 异常处理示例
```python
try:
    with open(file_path, 'rb') as f:
        # 处理文件
        pass
except FileNotFoundError:
    logger.error(f"文件未找到: {file_path}")
    raise
except IOError as e:
    logger.error(f"文件读取错误: {file_path}, {str(e)}")
    raise
```

## 6. 日志记录

### 6.1 日志级别使用
- `DEBUG`: 详细信息，通常只在诊断问题时使用
- `INFO`: 确认事情按预期工作
- `WARNING`: 表示发生了意外情况，但程序仍能正常工作
- `ERROR`: 由于严重问题，程序的某些功能无法执行
- `CRITICAL`: 严重错误，程序可能无法继续运行

### 6.2 日志记录示例
```python
import logging

logger = logging.getLogger(__name__)

def process_image(file_path: str):
    logger.info(f"开始处理图片: {file_path}")
    try:
        # 处理逻辑
        pass
    except Exception as e:
        logger.error(f"处理图片失败: {file_path}, 错误: {str(e)}")
        raise
```

## 7. PyQt6特定规范

### 7.1 信号和槽
```python
class Worker(QObject):
    # 信号命名使用过去式动词
    finished = pyqtSignal()
    progress_updated = pyqtSignal(int, str)
    
    def do_work(self):
        # 槽函数命名使用动词原形
        pass
```

### 7.2 资源管理
```python
class ImageWidget(QWidget):
    def __init__(self):
        super().__init__()
        self._pixmaps = {}  # 缓存Pixmap对象
        
    def __del__(self):
        # 清理资源
        self._pixmaps.clear()
```

## 8. 性能优化

### 8.1 避免重复计算
```python
class ImageCache:
    def __init__(self):
        self._cache = {}
        self._cache_time = {}
        
    def get_thumbnail(self, file_path: str) -> QPixmap:
        # 使用缓存避免重复计算
        if file_path in self._cache:
            return self._cache[file_path]
        # 计算并缓存
```

### 8.2 合理使用多线程
```python
class WorkerThread(QThread):
    def run(self):
        # 耗时操作在后台线程执行
        # 通过信号与主线程通信
        pass
```

## 9. 测试规范

### 9.1 单元测试
- 每个模块都应该有对应的测试文件
- 测试文件命名以 `test_` 开头，如 `test_image_utils.py`
- 使用pytest框架编写测试

### 9.2 测试示例
```python
def test_calculate_similarity():
    """测试相似度计算功能"""
    file1 = "test1.jpg"
    file2 = "test2.jpg"
    similarity = calculate_similarity(file1, file2)
    assert 0 <= similarity <= 1
```

## 10. 代码审查要点

### 10.1 审查清单
- [ ] 命名是否符合规范
- [ ] 是否有适当的类型提示
- [ ] 文档字符串是否完整
- [ ] 错误处理是否恰当
- [ ] 日志记录是否合理
- [ ] 资源是否正确释放
- [ ] 性能是否有优化空间
- [ ] 是否有对应的单元测试