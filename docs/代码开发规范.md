# ImageTrim 代码开发规范

## 📋 概览

本文档定义了ImageTrim项目的代码开发规范，确保代码质量和一致性。所有开发者都应该遵循这些规范。

## 1. 🏷️ 命名规范

### 1.1 文件命名
- **Python文件**: 使用小写字母和下划线命名，如 `image_utils.py`
- **模块文件**: 功能模块统一使用 `module.py`，如 `deduplication/module.py`
- **UI文件**: 界面组件使用 `ui.py`，如 `deduplication/ui.py`
- **逻辑文件**: 业务逻辑使用 `logic.py`，如 `deduplication/logic.py`

### 1.2 类命名
- **基类**: 抽象基类以 `Base` 开头，如 `BaseFunctionModule`
- **功能类**: 模块类以功能命名，如 `DeduplicationModule`
- **UI类**: PyQt组件类以 `Widget`、`Dialog`或`Panel`结尾，如 `SettingsWidget`
- **异常类**: 以 `Error` 或 `Exception` 结尾，如 `ModuleNotFoundError`

### 1.3 函数命名
- **公共函数**: 使用动词开头，如 `calculate_hash`, `load_image`
- **私有函数**: 以下划线开头，如 `_process_file`
- **属性访问器**: 使用 `get_` 和 `set_` 前缀，如 `get_file_info`
- **事件处理**: 使用 `on_` 前缀，如 `on_button_click`

## 2. 📝 代码格式

### 2.1 缩进和空格
- 使用**4个空格**进行缩进，不使用Tab
- 操作符两侧添加空格，如 `a = b + c`
- 逗号后添加空格，如 `func(a, b, c)`
- 函数定义和调用时参数列表的括号内侧不加空格

### 2.2 行长度
- 每行不超过**88个字符**（兼容black格式化工具）
- 长表达式使用括号换行，保持一致的缩进
- 字符串拼接使用括号而非反斜杠

### 2.3 空行规范
- **模块级别**: 类定义前后各空两行
- **类级别**: 方法定义前后各空一行
- **逻辑分组**: 相关功能的代码块之间空一行
- **避免过度空行**: 不要有连续的空行

## 3. 🔧 类型提示

### 3.1 函数类型提示
**必须为所有公共函数添加类型提示**：
```python
from typing import List, Dict, Optional, Any
from PyQt6.QtCore import pyqtSignal

def calculate_similarity(file1: str, file2: str) -> float:
    """计算两个文件的相似度"""
    pass

def process_files(files: List[str]) -> Dict[str, Any]:
    """处理文件列表"""
    pass

# PyQt6信号也要有类型提示
class WorkerSignals(QObject):
    finished = pyqtSignal()  # 无参数信号
    progress_updated = pyqtSignal(int, str)  # 带参数信号
```

### 3.2 变量类型提示
**重要变量和类属性应该添加类型提示**：
```python
from typing import List, Dict, Optional, Any
from PyQt6.QtGui import QPixmap

file_path: str = "/path/to/file"
file_list: List[str] = []
result: Optional[Dict[str, Any]] = None
thumbnail_cache: Dict[str, QPixmap] = {}
```

## 4. 📚 文档字符串

### 4.1 模块文档字符串
**每个模块都应该有详细的文档字符串**：
```python
"""
图片去重模块

提供基于图像哈希算法的图片相似度检测和去重功能。
支持多种哈希算法，包括感知哈希、差异哈希和小波哈希。

主要功能:
- 图片相似度计算
- 重复图片检测
- 批量处理支持
- 可配置的相似度阈值

作者: ImageTrim Team
创建日期: 2025-10-12
版本: 1.0.0

依赖:
    - PIL (Pillow)
    - imagehash
    - numpy
"""
```

### 4.2 类文档字符串
**类的文档字符串应包含用途、属性和方法说明**：
```python
class DeduplicationModule(BaseFunctionModule):
    """
    图片去重功能模块

    实现基于图像哈希算法的图片去重功能，支持多种哈希算法
    和可配置的相似度阈值。提供完整的UI界面和后台处理逻辑。

    继承自:
        BaseFunctionModule: 功能模块基类

    属性:
        similarity_threshold (float): 相似度阈值，默认0.85
        hash_algorithm (str): 哈希算法类型，默认'average'
        min_file_size (int): 最小文件大小(字节)，默认1024

    信号:
        progress_updated: 进度更新信号
        scan_completed: 扫描完成信号
        duplicates_found: 发现重复项信号
    """
```

### 4.3 函数文档字符串
**函数文档字符串应包含参数、返回值和异常说明**：
```python
def calculate_image_hash(self, file_path: str, hash_type: str = "average") -> str:
    """
    计算图片的哈希值

    使用指定的哈希算法计算图片文件的哈希值，用于相似度比较。

    Args:
        file_path (str): 图片文件路径
        hash_type (str, optional): 哈希算法类型
            可选值: 'average', 'difference', 'wavelet'
            默认值: 'average'

    Returns:
        str: 图片的哈希值字符串

    Raises:
        FileNotFoundError: 文件不存在时抛出
        PIL.UnidentifiedImageError: 无法识别的图片格式
        ValueError: 不支持的哈希算法类型
        MemoryError: 图片太大导致内存不足

    示例:
        >>> hash_value = calculate_image_hash("test.jpg", "average")
        >>> print(len(hash_value))
        64
    """
```

## 5. 错误处理

### 5.1 异常处理原则
- 优先使用具体的异常类型，而不是通用的 `Exception`
- 提供有意义的错误信息
- 避免忽略异常（空的except块）

### 5.2 异常处理示例
```python
try:
    with open(file_path, 'rb') as f:
        # 处理文件
        pass
except FileNotFoundError:
    logger.error(f"文件未找到: {file_path}")
    raise
except IOError as e:
    logger.error(f"文件读取错误: {file_path}, {str(e)}")
    raise
```

## 6. 日志记录

### 6.1 日志级别使用
- `DEBUG`: 详细信息，通常只在诊断问题时使用
- `INFO`: 确认事情按预期工作
- `WARNING`: 表示发生了意外情况，但程序仍能正常工作
- `ERROR`: 由于严重问题，程序的某些功能无法执行
- `CRITICAL`: 严重错误，程序可能无法继续运行

### 6.2 日志记录示例
```python
import logging

logger = logging.getLogger(__name__)

def process_image(file_path: str):
    logger.info(f"开始处理图片: {file_path}")
    try:
        # 处理逻辑
        pass
    except Exception as e:
        logger.error(f"处理图片失败: {file_path}, 错误: {str(e)}")
        raise
```

## 7. PyQt6特定规范

### 7.1 信号和槽
```python
class Worker(QObject):
    # 信号命名使用过去式动词
    finished = pyqtSignal()
    progress_updated = pyqtSignal(int, str)
    
    def do_work(self):
        # 槽函数命名使用动词原形
        pass
```

### 7.2 资源管理
```python
class ImageWidget(QWidget):
    def __init__(self):
        super().__init__()
        self._pixmaps = {}  # 缓存Pixmap对象
        
    def __del__(self):
        # 清理资源
        self._pixmaps.clear()
```

## 8. 性能优化

### 8.1 避免重复计算
```python
class ImageCache:
    def __init__(self):
        self._cache = {}
        self._cache_time = {}
        
    def get_thumbnail(self, file_path: str) -> QPixmap:
        # 使用缓存避免重复计算
        if file_path in self._cache:
            return self._cache[file_path]
        # 计算并缓存
```

### 8.2 合理使用多线程
```python
class WorkerThread(QThread):
    def run(self):
        # 耗时操作在后台线程执行
        # 通过信号与主线程通信
        pass
```

## 9. 测试规范

### 9.1 单元测试
- 每个模块都应该有对应的测试文件
- 测试文件命名以 `test_` 开头，如 `test_image_utils.py`
- 使用pytest框架编写测试

### 9.2 测试示例
```python
def test_calculate_similarity():
    """测试相似度计算功能"""
    file1 = "test1.jpg"
    file2 = "test2.jpg"
    similarity = calculate_similarity(file1, file2)
    assert 0 <= similarity <= 1
```

## 10. 代码审查要点

### 10.1 审查清单
- [ ] 命名是否符合规范
- [ ] 是否有适当的类型提示
- [ ] 文档字符串是否完整
- [ ] 错误处理是否恰当
- [ ] 日志记录是否合理
- [ ] 资源是否正确释放
- [ ] 性能是否有优化空间
- [ ] 是否有对应的单元测试