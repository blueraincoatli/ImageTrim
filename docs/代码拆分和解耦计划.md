# ä»£ç æ‹†åˆ†å’Œè§£è€¦è®¡åˆ’

## 1. å½“å‰ä»£ç ç»“æ„åˆ†æ

### 1.1 ä¸»è¦æ–‡ä»¶
1. **improved_main_app_v3.py** - ä¸»åº”ç”¨æ–‡ä»¶ï¼ˆçº¦500è¡Œï¼‰
   - åŒ…å«ä¸»åº”ç”¨ç±»`ImprovedModernApp`
   - è´Ÿè´£UIå¸ƒå±€ã€ä¸»é¢˜è®¾ç½®ã€æ¨¡å—ç®¡ç†ã€UIæ›´æ–°ç­‰

2. **improved_deduplication_module.py** - å›¾ç‰‡å»é‡åŠŸèƒ½æ¨¡å—ï¼ˆçº¦2200è¡Œï¼‰
   - åŒ…å«`ImprovedDeduplicationModule`ç±»
   - é›†æˆäº†å¤§é‡åŠŸèƒ½ï¼šUIåˆ›å»ºã€ä¸šåŠ¡é€»è¾‘ã€å›¾ç‰‡å¤„ç†ã€äº‹ä»¶å¤„ç†ç­‰

3. **function_modules.py** - åŠŸèƒ½æ¨¡å—åŸºç±»ï¼ˆçº¦50è¡Œï¼‰
   - å®šä¹‰`BaseFunctionModule`æŠ½è±¡åŸºç±»
   - å®šä¹‰`FunctionManager`åŠŸèƒ½ç®¡ç†å™¨

### 1.2 ä¸»è¦é—®é¢˜
1. **åŠŸèƒ½æ¨¡å—è¿‡äºåºå¤§**ï¼š`improved_deduplication_module.py`æ–‡ä»¶è¿‡å¤§ï¼ŒèŒè´£ä¸æ¸…æ™°
2. **UIä¸ä¸šåŠ¡é€»è¾‘è€¦åˆ**ï¼šå›¾ç‰‡å¤„ç†é€»è¾‘ä¸UIåˆ›å»ºå’Œäº‹ä»¶å¤„ç†æ··åˆåœ¨ä¸€èµ·
3. **ä»£ç å¤ç”¨æ€§å·®**ï¼šå¤§é‡é‡å¤ä»£ç ï¼Œå¦‚å›¾ç‰‡ç¼“å­˜ã€UIç»„ä»¶åˆ›å»ºç­‰
4. **ç»´æŠ¤å›°éš¾**ï¼šå•ä¸ªæ–‡ä»¶è¿‡å¤§ï¼Œä¿®æ”¹æ—¶å®¹æ˜“å¼•å…¥é”™è¯¯

## 2. æ‹†åˆ†å’Œè§£è€¦ç›®æ ‡

### 2.1 çŸ­æœŸç›®æ ‡
1. å°†`improved_deduplication_module.py`æ‹†åˆ†ä¸ºå¤šä¸ªåŠŸèƒ½æ˜ç¡®çš„æ¨¡å—
2. åˆ†ç¦»UIé€»è¾‘å’Œä¸šåŠ¡é€»è¾‘
3. æå–å¯å¤ç”¨çš„å·¥å…·ç±»å’Œç»„ä»¶
4. ä¿æŒç°æœ‰åŠŸèƒ½ä¸å˜

### 2.2 é•¿æœŸç›®æ ‡
1. å»ºç«‹æ¸…æ™°çš„æ¨¡å—åŒ–æ¶æ„
2. æé«˜ä»£ç å¯æµ‹è¯•æ€§å’Œå¯ç»´æŠ¤æ€§
3. æ”¯æŒæ›´ä¾¿æ·çš„åŠŸèƒ½æ‰©å±•
4. ä¸ºPyQt6é‡æ„å¥ å®šåŸºç¡€

## 3. æ‹†åˆ†è®¡åˆ’

### 3.1 ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„æ‹†åˆ†
**ç›®æ ‡**ï¼šæ‹†åˆ†æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼Œå»ºç«‹æ¸…æ™°çš„ç›®å½•ç»“æ„

#### 3.1.1 åˆ›å»ºæ–°çš„ç›®å½•ç»“æ„
```
E:\FFOutput\Dedup\
â”œâ”€â”€ core/                     # æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ function_manager.py   # åŠŸèƒ½ç®¡ç†å™¨
â”‚   â””â”€â”€ base_module.py        # åŠŸèƒ½æ¨¡å—åŸºç±»
â”œâ”€â”€ ui/                       # UIç›¸å…³æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main_window.py        # ä¸»çª—å£
â”‚   â”œâ”€â”€ components/           # UIç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ function_card.py  # åŠŸèƒ½å¡ç‰‡ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ image_viewer.py   # å›¾ç‰‡æŸ¥çœ‹å™¨
â”‚   â”‚   â””â”€â”€ selection_tools.py# é€‰æ‹©å·¥å…·
â”‚   â””â”€â”€ themes/               # ä¸»é¢˜ç®¡ç†
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ theme_manager.py  # ä¸»é¢˜ç®¡ç†å™¨
â”œâ”€â”€ modules/                  # åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ deduplication/        # å›¾ç‰‡å»é‡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ module.py         # æ¨¡å—å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ ui.py             # UIç›¸å…³
â”‚   â”‚   â””â”€â”€ logic.py          # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ utils.py          # ä¸“ç”¨å·¥å…·
â”‚   â””â”€â”€ avif_converter/       # AVIFè½¬æ¢æ¨¡å—
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ module.py
â”‚       â”œâ”€â”€ ui.py
â”‚       â””â”€â”€ logic.py
â”œâ”€â”€ utils/                    # é€šç”¨å·¥å…·
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ image_cache.py        # å›¾ç‰‡ç¼“å­˜ç®¡ç†
â”‚   â”œâ”€â”€ image_utils.py        # å›¾ç‰‡å¤„ç†å·¥å…·
â”‚   â””â”€â”€ ui_helpers.py         # UIè¾…åŠ©å·¥å…·
â””â”€â”€ main.py                   # ç¨‹åºå…¥å£
```

#### 3.1.2 æ‹†åˆ†improved_main_app_v3.py
1. å°†`ImprovedModernApp`ç±»ç§»åŠ¨åˆ°`ui/main_window.py`
2. æå–UIç»„ä»¶åˆ°`ui/components/`ç›®å½•
3. å°†ä¸»é¢˜è®¾ç½®ç›¸å…³ä»£ç ç§»åŠ¨åˆ°`ui/themes/theme_manager.py`

### 3.2 ç¬¬äºŒé˜¶æ®µï¼šåŠŸèƒ½æ¨¡å—æ‹†åˆ†
**ç›®æ ‡**ï¼šæ‹†åˆ†`improved_deduplication_module.py`ï¼Œåˆ†ç¦»UIå’Œä¸šåŠ¡é€»è¾‘

#### 3.2.1 æ‹†åˆ†å›¾ç‰‡å»é‡æ¨¡å—
1. **åˆ›å»ºåŸºç¡€æ¨¡å—ç±»**
   - ç§»åŠ¨`BaseFunctionModule`å’Œ`FunctionManager`åˆ°`core/`ç›®å½•

2. **åˆ†ç¦»UIé€»è¾‘**
   - å°†`create_settings_ui`å’Œ`create_workspace_ui`æ–¹æ³•ç§»åŠ¨åˆ°`modules/deduplication/ui.py`
   - æå–UIç»„ä»¶åˆ°`ui/components/`ç›®å½•

3. **åˆ†ç¦»ä¸šåŠ¡é€»è¾‘**
   - å°†`execute`æ–¹æ³•åŠç›¸å…³è¾…åŠ©æ–¹æ³•ç§»åŠ¨åˆ°`modules/deduplication/logic.py`
   - æå–å›¾ç‰‡å¤„ç†ç›¸å…³ä»£ç åˆ°`utils/image_utils.py`

4. **æå–å·¥å…·ç±»**
   - å°†`_ImageCache`ç±»ç§»åŠ¨åˆ°`utils/image_cache.py`
   - æå–UIè¾…åŠ©æ–¹æ³•åˆ°`utils/ui_helpers.py`

### 3.3 ç¬¬ä¸‰é˜¶æ®µï¼šä¼˜åŒ–å’Œé‡æ„
**ç›®æ ‡**ï¼šä¼˜åŒ–ä»£ç ç»“æ„ï¼Œæé«˜å¯ç»´æŠ¤æ€§

#### 3.3.1 ä¼˜åŒ–æ¨¡å—æ¥å£
1. å®šä¹‰æ¸…æ™°çš„æ¨¡å—æ¥å£è§„èŒƒ
2. ç»Ÿä¸€å›è°ƒæœºåˆ¶
3. æ ‡å‡†åŒ–é…ç½®ç®¡ç†

#### 3.3.2 æå–å…¬å…±ç»„ä»¶
1. æå–å¯å¤ç”¨çš„UIç»„ä»¶
2. åˆ›å»ºé€šç”¨çš„å›¾ç‰‡å¤„ç†å·¥å…·
3. å»ºç«‹ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶

## 4. è¯¦ç»†æ‹†åˆ†æ­¥éª¤

### 4.1 ç¬¬ä¸€é˜¶æ®µè¯¦ç»†æ­¥éª¤

#### 4.1.1 åˆ›å»ºç›®å½•ç»“æ„
1. åˆ›å»º`core/`ã€`ui/`ã€`modules/`ã€`utils/`ç›®å½•
2. åœ¨æ¯ä¸ªç›®å½•ä¸‹åˆ›å»º`__init__.py`æ–‡ä»¶
3. åˆ›å»ºå­ç›®å½•ç»“æ„

#### 4.1.2 æ‹†åˆ†ä¸»åº”ç”¨æ–‡ä»¶
1. åˆ›å»º`ui/main_window.py`ï¼š
   ```python
   # ç§»åŠ¨ImprovedModernAppç±»åŠç›¸å…³ä»£ç 
   class MainWindow:
       def __init__(self, root):
           # ...
   
       def setup_custom_theme(self):
           # ...
   
       def create_main_layout(self):
           # ...
   ```

2. åˆ›å»º`ui/themes/theme_manager.py`ï¼š
   ```python
   class ThemeManager:
       def __init__(self):
           # ...
   
       def setup_theme(self, style):
           # ...
   ```

3. åˆ›å»º`ui/components/function_card.py`ï¼š
   ```python
   class FunctionCard:
       def __init__(self, parent, module):
           # ...
   
       def bind_events(self, callback):
           # ...
   ```

### 4.2 ç¬¬äºŒé˜¶æ®µè¯¦ç»†æ­¥éª¤

#### 4.2.1 æ‹†åˆ†æ ¸å¿ƒæ¨¡å—
1. åˆ›å»º`core/base_module.py`ï¼š
   ```python
   from abc import ABC, abstractmethod
   
   class BaseFunctionModule(ABC):
       # ç§»åŠ¨åŸæœ‰ä»£ç 
       pass
   
   class FunctionManager:
       # ç§»åŠ¨åŸæœ‰ä»£ç 
       pass
   ```

2. æ›´æ–°`core/function_manager.py`ï¼š
   ```python
   from .base_module import BaseFunctionModule, FunctionManager
   
   # å¯ä»¥æ·»åŠ é¢å¤–çš„åŠŸèƒ½ç®¡ç†é€»è¾‘
   ```

#### 4.2.2 æ‹†åˆ†å›¾ç‰‡å»é‡æ¨¡å—
1. åˆ›å»º`modules/deduplication/module.py`ï¼š
   ```python
   from core.base_module import BaseFunctionModule
   
   class ImprovedDeduplicationModule(BaseFunctionModule):
       def __init__(self):
           super().__init__(
               name="improved_deduplication",
               display_name="Improved Image Deduplication",
               description="Find and process duplicate or similar images with advanced selection.",
               icon="ğŸ”"
           )
           # åˆå§‹åŒ–å±æ€§
   ```

2. åˆ›å»º`modules/deduplication/ui.py`ï¼š
   ```python
   class DeduplicationUI:
       def create_settings_ui(self, parent):
           # ç§»åŠ¨åŸæœ‰create_settings_uiä»£ç 
           pass
   
       def create_workspace_ui(self, parent):
           # ç§»åŠ¨åŸæœ‰create_workspace_uiä»£ç 
           pass
   ```

3. åˆ›å»º`modules/deduplication/logic.py`ï¼š
   ```python
   class DeduplicationLogic:
       def execute(self, params):
           # ç§»åŠ¨åŸæœ‰executeæ–¹æ³•åŠç›¸å…³è¾…åŠ©æ–¹æ³•
           pass
   
       def find_duplicates(self, hashes, threshold):
           # ç§»åŠ¨æŸ¥æ‰¾é‡å¤é¡¹çš„é€»è¾‘
           pass
   ```

4. åˆ›å»º`modules/deduplication/utils.py`ï¼š
   ```python
   class DeduplicationUtils:
       # ç§»åŠ¨ä¸“ç”¨çš„è¾…åŠ©æ–¹æ³•
       pass
   ```

#### 4.2.3 æå–å·¥å…·ç±»
1. åˆ›å»º`utils/image_cache.py`ï¼š
   ```python
   class ImageCache:
       def __init__(self, max_size=100):
           # ç§»åŠ¨_ImageCacheç±»
           pass
   ```

2. åˆ›å»º`utils/image_utils.py`ï¼š
   ```python
   class ImageUtils:
       @staticmethod
       def calculate_hash(file_path):
           # ç§»åŠ¨å›¾ç‰‡å“ˆå¸Œè®¡ç®—ç›¸å…³ä»£ç 
           pass
   
       @staticmethod
       def get_thumbnail(file_path, size):
           # ç§»åŠ¨ç¼©ç•¥å›¾ç”Ÿæˆç›¸å…³ä»£ç 
           pass
   ```

3. åˆ›å»º`utils/ui_helpers.py`ï¼š
   ```python
   class UIHelpers:
       @staticmethod
       def update_widget_selection_state(widget, is_selected):
           # ç§»åŠ¨UIçŠ¶æ€æ›´æ–°ç›¸å…³ä»£ç 
           pass
   
       @staticmethod
       def bind_image_events(img_label, callback):
           # ç§»åŠ¨äº‹ä»¶ç»‘å®šç›¸å…³ä»£ç 
           pass
   ```

### 4.3 ç¬¬ä¸‰é˜¶æ®µè¯¦ç»†æ­¥éª¤

#### 4.3.1 ä¼˜åŒ–æ¨¡å—æ¥å£
1. å®šä¹‰ç»Ÿä¸€çš„å›è°ƒæ¥å£ï¼š
   ```python
   # core/callbacks.py
   from typing import Callable, Any, Dict
   
   class Callbacks:
       def __init__(self):
           self.progress_callback: Callable[[float, str], None] = None
           self.log_callback: Callable[[str, str], None] = None
           self.ui_update_callback: Callable[[str, Any], None] = None
   ```

2. æ ‡å‡†åŒ–é…ç½®ç®¡ç†ï¼š
   ```python
   # core/config.py
   class Config:
       def __init__(self):
           self.theme = "dark"
           self.language = "zh_CN"
           self.thumbnail_size = 80
           # å…¶ä»–é…ç½®é¡¹
   ```

#### 4.3.2 æå–å…¬å…±ç»„ä»¶
1. åˆ›å»ºé€šç”¨å›¾ç‰‡æŸ¥çœ‹å™¨ï¼š
   ```python
   # ui/components/image_viewer.py
   class ImageViewer:
       def __init__(self, parent):
           # åˆ›å»ºé€šç”¨çš„å›¾ç‰‡æŸ¥çœ‹å™¨ç»„ä»¶
           pass
   ```

2. åˆ›å»ºé€‰æ‹©å·¥å…·ï¼š
   ```python
   # ui/components/selection_tools.py
   class SelectionTools:
       def __init__(self):
           # åˆ›å»ºé€šç”¨çš„é€‰æ‹©å·¥å…·
           pass
   ```

## 5. ä¾èµ–å…³ç³»ç®¡ç†

### 5.1 æ¨¡å—ä¾èµ–å…³ç³»
```
main.py
â”œâ”€â”€ ui.main_window
â”‚   â”œâ”€â”€ ui.themes.theme_manager
â”‚   â”œâ”€â”€ ui.components.function_card
â”‚   â””â”€â”€ core.function_manager
â”œâ”€â”€ modules.deduplication.module
â”‚   â”œâ”€â”€ core.base_module
â”‚   â”œâ”€â”€ modules.deduplication.ui
â”‚   â”œâ”€â”€ modules.deduplication.logic
â”‚   â””â”€â”€ modules.deduplication.utils
â””â”€â”€ utils
    â”œâ”€â”€ utils.image_cache
    â”œâ”€â”€ utils.image_utils
    â””â”€â”€ utils.ui_helpers
```

### 5.2 ä¾èµ–æ³¨å…¥
é‡‡ç”¨ä¾èµ–æ³¨å…¥æ¨¡å¼é™ä½æ¨¡å—é—´çš„è€¦åˆåº¦ï¼š
```python
# ç¤ºä¾‹ï¼šåœ¨æ¨¡å—åˆå§‹åŒ–æ—¶æ³¨å…¥ä¾èµ–
class ImprovedDeduplicationModule(BaseFunctionModule):
    def __init__(self, image_cache=None, image_utils=None):
        super().__init__(...)
        self.image_cache = image_cache or ImageCache()
        self.image_utils = image_utils or ImageUtils()
```

## 6. å®æ–½è®¡åˆ’

### 6.1 ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰
1. åˆ›å»ºæ–°çš„ç›®å½•ç»“æ„
2. æ‹†åˆ†ä¸»åº”ç”¨æ–‡ä»¶
3. æå–UIç»„ä»¶
4. å»ºç«‹åŸºç¡€æ¨¡å—æ¶æ„

### 6.2 ç¬¬äºŒé˜¶æ®µï¼ˆ2-3å‘¨ï¼‰
1. æ‹†åˆ†åŠŸèƒ½æ¨¡å—
2. åˆ†ç¦»UIå’Œä¸šåŠ¡é€»è¾‘
3. æå–å·¥å…·ç±»
4. å»ºç«‹æ¨¡å—é—´æ¥å£

### 6.3 ç¬¬ä¸‰é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰
1. ä¼˜åŒ–æ¨¡å—æ¥å£
2. æå–å…¬å…±ç»„ä»¶
3. å®Œå–„ä¾èµ–ç®¡ç†
4. æµ‹è¯•å’ŒéªŒè¯

## 7. é£é™©æ§åˆ¶

### 7.1 æŠ€æœ¯é£é™©
1. **åŠŸèƒ½ä¸¢å¤±**ï¼šåœ¨æ‹†åˆ†è¿‡ç¨‹ä¸­å¯èƒ½é—æ¼æŸäº›åŠŸèƒ½
   - åº”å¯¹æªæ–½ï¼šå»ºç«‹è¯¦ç»†çš„åŠŸèƒ½æ¸…å•ï¼Œé€ä¸€éªŒè¯

2. **æ€§èƒ½ä¸‹é™**ï¼šæ¨¡å—æ‹†åˆ†å¯èƒ½å¼•å…¥é¢å¤–çš„è°ƒç”¨å¼€é”€
   - åº”å¯¹æªæ–½ï¼šè¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œä¼˜åŒ–å…³é”®è·¯å¾„

### 7.2 é¡¹ç›®é£é™©
1. **è¿›åº¦å»¶æœŸ**ï¼šæ‹†åˆ†å·¥ä½œé‡å¤§å¯èƒ½å¯¼è‡´å»¶æœŸ
   - åº”å¯¹æªæ–½ï¼šåˆ¶å®šè¯¦ç»†è®¡åˆ’ï¼Œåˆ†é˜¶æ®µäº¤ä»˜

2. **å›¢é˜Ÿåä½œ**ï¼šå¤šäººåä½œå¯èƒ½å¼•å…¥ä»£ç å†²çª
   - åº”å¯¹æªæ–½ï¼šå»ºç«‹ä»£ç è§„èŒƒï¼Œä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶

## 8. è´¨é‡ä¿è¯

### 8.1 ä»£ç è´¨é‡
1. éµå¾ªPEP 8è§„èŒƒ
2. ä½¿ç”¨ç±»å‹æç¤º
3. ç¼–å†™å•å…ƒæµ‹è¯•
4. è¿›è¡Œä»£ç å®¡æŸ¥

### 8.2 åŠŸèƒ½éªŒè¯
1. ä¿æŒåŸæœ‰åŠŸèƒ½ä¸å˜
2. è¿›è¡Œå›å½’æµ‹è¯•
3. ç”¨æˆ·éªŒæ”¶æµ‹è¯•
4. æ€§èƒ½åŸºå‡†æµ‹è¯•

é€šè¿‡ä»¥ä¸Šæ‹†åˆ†å’Œè§£è€¦è®¡åˆ’ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿå»ºç«‹ä¸€ä¸ªæ›´åŠ æ¸…æ™°ã€å¯ç»´æŠ¤å’Œå¯æ‰©å±•çš„ä»£ç æ¶æ„ï¼Œä¸ºåç»­çš„PyQt6é‡æ„å¥ å®šåšå®çš„åŸºç¡€ã€‚