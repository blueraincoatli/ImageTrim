# 代码拆分和解耦计划

## 1. 当前代码结构分析

### 1.1 主要文件
1. **improved_main_app_v3.py** - 主应用文件（约500行）
   - 包含主应用类`ImprovedModernApp`
   - 负责UI布局、主题设置、模块管理、UI更新等

2. **improved_deduplication_module.py** - 图片去重功能模块（约2200行）
   - 包含`ImprovedDeduplicationModule`类
   - 集成了大量功能：UI创建、业务逻辑、图片处理、事件处理等

3. **function_modules.py** - 功能模块基类（约50行）
   - 定义`BaseFunctionModule`抽象基类
   - 定义`FunctionManager`功能管理器

### 1.2 主要问题
1. **功能模块过于庞大**：`improved_deduplication_module.py`文件过大，职责不清晰
2. **UI与业务逻辑耦合**：图片处理逻辑与UI创建和事件处理混合在一起
3. **代码复用性差**：大量重复代码，如图片缓存、UI组件创建等
4. **维护困难**：单个文件过大，修改时容易引入错误

## 2. 拆分和解耦目标

### 2.1 短期目标
1. 将`improved_deduplication_module.py`拆分为多个功能明确的模块
2. 分离UI逻辑和业务逻辑
3. 提取可复用的工具类和组件
4. 保持现有功能不变

### 2.2 长期目标
1. 建立清晰的模块化架构
2. 提高代码可测试性和可维护性
3. 支持更便捷的功能扩展
4. 为PyQt6重构奠定基础

## 3. 拆分计划

### 3.1 第一阶段：基础架构拆分
**目标**：拆分核心功能模块，建立清晰的目录结构

#### 3.1.1 创建新的目录结构
```
E:\FFOutput\Dedup\
├── core/                     # 核心模块
│   ├── __init__.py
│   ├── function_manager.py   # 功能管理器
│   └── base_module.py        # 功能模块基类
├── ui/                       # UI相关模块
│   ├── __init__.py
│   ├── main_window.py        # 主窗口
│   ├── components/           # UI组件
│   │   ├── __init__.py
│   │   ├── function_card.py  # 功能卡片组件
│   │   ├── image_viewer.py   # 图片查看器
│   │   └── selection_tools.py# 选择工具
│   └── themes/               # 主题管理
│       ├── __init__.py
│       └── theme_manager.py  # 主题管理器
├── modules/                  # 功能模块
│   ├── __init__.py
│   ├── deduplication/        # 图片去重模块
│   │   ├── __init__.py
│   │   ├── module.py         # 模块定义
│   │   ├── ui.py             # UI相关
│   │   └── logic.py          # 业务逻辑
│   │   └── utils.py          # 专用工具
│   └── avif_converter/       # AVIF转换模块
│       ├── __init__.py
│       ├── module.py
│       ├── ui.py
│       └── logic.py
├── utils/                    # 通用工具
│   ├── __init__.py
│   ├── image_cache.py        # 图片缓存管理
│   ├── image_utils.py        # 图片处理工具
│   └── ui_helpers.py         # UI辅助工具
└── main.py                   # 程序入口
```

#### 3.1.2 拆分improved_main_app_v3.py
1. 将`ImprovedModernApp`类移动到`ui/main_window.py`
2. 提取UI组件到`ui/components/`目录
3. 将主题设置相关代码移动到`ui/themes/theme_manager.py`

### 3.2 第二阶段：功能模块拆分
**目标**：拆分`improved_deduplication_module.py`，分离UI和业务逻辑

#### 3.2.1 拆分图片去重模块
1. **创建基础模块类**
   - 移动`BaseFunctionModule`和`FunctionManager`到`core/`目录

2. **分离UI逻辑**
   - 将`create_settings_ui`和`create_workspace_ui`方法移动到`modules/deduplication/ui.py`
   - 提取UI组件到`ui/components/`目录

3. **分离业务逻辑**
   - 将`execute`方法及相关辅助方法移动到`modules/deduplication/logic.py`
   - 提取图片处理相关代码到`utils/image_utils.py`

4. **提取工具类**
   - 将`_ImageCache`类移动到`utils/image_cache.py`
   - 提取UI辅助方法到`utils/ui_helpers.py`

### 3.3 第三阶段：优化和重构
**目标**：优化代码结构，提高可维护性

#### 3.3.1 优化模块接口
1. 定义清晰的模块接口规范
2. 统一回调机制
3. 标准化配置管理

#### 3.3.2 提取公共组件
1. 提取可复用的UI组件
2. 创建通用的图片处理工具
3. 建立统一的错误处理机制

## 4. 详细拆分步骤

### 4.1 第一阶段详细步骤

#### 4.1.1 创建目录结构
1. 创建`core/`、`ui/`、`modules/`、`utils/`目录
2. 在每个目录下创建`__init__.py`文件
3. 创建子目录结构

#### 4.1.2 拆分主应用文件
1. 创建`ui/main_window.py`：
   ```python
   # 移动ImprovedModernApp类及相关代码
   class MainWindow:
       def __init__(self, root):
           # ...
   
       def setup_custom_theme(self):
           # ...
   
       def create_main_layout(self):
           # ...
   ```

2. 创建`ui/themes/theme_manager.py`：
   ```python
   class ThemeManager:
       def __init__(self):
           # ...
   
       def setup_theme(self, style):
           # ...
   ```

3. 创建`ui/components/function_card.py`：
   ```python
   class FunctionCard:
       def __init__(self, parent, module):
           # ...
   
       def bind_events(self, callback):
           # ...
   ```

### 4.2 第二阶段详细步骤

#### 4.2.1 拆分核心模块
1. 创建`core/base_module.py`：
   ```python
   from abc import ABC, abstractmethod
   
   class BaseFunctionModule(ABC):
       # 移动原有代码
       pass
   
   class FunctionManager:
       # 移动原有代码
       pass
   ```

2. 更新`core/function_manager.py`：
   ```python
   from .base_module import BaseFunctionModule, FunctionManager
   
   # 可以添加额外的功能管理逻辑
   ```

#### 4.2.2 拆分图片去重模块
1. 创建`modules/deduplication/module.py`：
   ```python
   from core.base_module import BaseFunctionModule
   
   class ImprovedDeduplicationModule(BaseFunctionModule):
       def __init__(self):
           super().__init__(
               name="improved_deduplication",
               display_name="Improved Image Deduplication",
               description="Find and process duplicate or similar images with advanced selection.",
               icon="🔍"
           )
           # 初始化属性
   ```

2. 创建`modules/deduplication/ui.py`：
   ```python
   class DeduplicationUI:
       def create_settings_ui(self, parent):
           # 移动原有create_settings_ui代码
           pass
   
       def create_workspace_ui(self, parent):
           # 移动原有create_workspace_ui代码
           pass
   ```

3. 创建`modules/deduplication/logic.py`：
   ```python
   class DeduplicationLogic:
       def execute(self, params):
           # 移动原有execute方法及相关辅助方法
           pass
   
       def find_duplicates(self, hashes, threshold):
           # 移动查找重复项的逻辑
           pass
   ```

4. 创建`modules/deduplication/utils.py`：
   ```python
   class DeduplicationUtils:
       # 移动专用的辅助方法
       pass
   ```

#### 4.2.3 提取工具类
1. 创建`utils/image_cache.py`：
   ```python
   class ImageCache:
       def __init__(self, max_size=100):
           # 移动_ImageCache类
           pass
   ```

2. 创建`utils/image_utils.py`：
   ```python
   class ImageUtils:
       @staticmethod
       def calculate_hash(file_path):
           # 移动图片哈希计算相关代码
           pass
   
       @staticmethod
       def get_thumbnail(file_path, size):
           # 移动缩略图生成相关代码
           pass
   ```

3. 创建`utils/ui_helpers.py`：
   ```python
   class UIHelpers:
       @staticmethod
       def update_widget_selection_state(widget, is_selected):
           # 移动UI状态更新相关代码
           pass
   
       @staticmethod
       def bind_image_events(img_label, callback):
           # 移动事件绑定相关代码
           pass
   ```

### 4.3 第三阶段详细步骤

#### 4.3.1 优化模块接口
1. 定义统一的回调接口：
   ```python
   # core/callbacks.py
   from typing import Callable, Any, Dict
   
   class Callbacks:
       def __init__(self):
           self.progress_callback: Callable[[float, str], None] = None
           self.log_callback: Callable[[str, str], None] = None
           self.ui_update_callback: Callable[[str, Any], None] = None
   ```

2. 标准化配置管理：
   ```python
   # core/config.py
   class Config:
       def __init__(self):
           self.theme = "dark"
           self.language = "zh_CN"
           self.thumbnail_size = 80
           # 其他配置项
   ```

#### 4.3.2 提取公共组件
1. 创建通用图片查看器：
   ```python
   # ui/components/image_viewer.py
   class ImageViewer:
       def __init__(self, parent):
           # 创建通用的图片查看器组件
           pass
   ```

2. 创建选择工具：
   ```python
   # ui/components/selection_tools.py
   class SelectionTools:
       def __init__(self):
           # 创建通用的选择工具
           pass
   ```

## 5. 依赖关系管理

### 5.1 模块依赖关系
```
main.py
├── ui.main_window
│   ├── ui.themes.theme_manager
│   ├── ui.components.function_card
│   └── core.function_manager
├── modules.deduplication.module
│   ├── core.base_module
│   ├── modules.deduplication.ui
│   ├── modules.deduplication.logic
│   └── modules.deduplication.utils
└── utils
    ├── utils.image_cache
    ├── utils.image_utils
    └── utils.ui_helpers
```

### 5.2 依赖注入
采用依赖注入模式降低模块间的耦合度：
```python
# 示例：在模块初始化时注入依赖
class ImprovedDeduplicationModule(BaseFunctionModule):
    def __init__(self, image_cache=None, image_utils=None):
        super().__init__(...)
        self.image_cache = image_cache or ImageCache()
        self.image_utils = image_utils or ImageUtils()
```

## 6. 实施计划

### 6.1 第一阶段（1-2周）
1. 创建新的目录结构
2. 拆分主应用文件
3. 提取UI组件
4. 建立基础模块架构

### 6.2 第二阶段（2-3周）
1. 拆分功能模块
2. 分离UI和业务逻辑
3. 提取工具类
4. 建立模块间接口

### 6.3 第三阶段（1-2周）
1. 优化模块接口
2. 提取公共组件
3. 完善依赖管理
4. 测试和验证

## 7. 风险控制

### 7.1 技术风险
1. **功能丢失**：在拆分过程中可能遗漏某些功能
   - 应对措施：建立详细的功能清单，逐一验证

2. **性能下降**：模块拆分可能引入额外的调用开销
   - 应对措施：进行性能测试，优化关键路径

### 7.2 项目风险
1. **进度延期**：拆分工作量大可能导致延期
   - 应对措施：制定详细计划，分阶段交付

2. **团队协作**：多人协作可能引入代码冲突
   - 应对措施：建立代码规范，使用版本控制

## 8. 质量保证

### 8.1 代码质量
1. 遵循PEP 8规范
2. 使用类型提示
3. 编写单元测试
4. 进行代码审查

### 8.2 功能验证
1. 保持原有功能不变
2. 进行回归测试
3. 用户验收测试
4. 性能基准测试

通过以上拆分和解耦计划，我们将能够建立一个更加清晰、可维护和可扩展的代码架构，为后续的PyQt6重构奠定坚实的基础。