# æ¨¡å—æ¥å£å’Œä¾èµ–å…³ç³»å®šä¹‰

## 1. æ ¸å¿ƒæ¨¡å—æ¥å£

### 1.1 BaseFunctionModuleæ¥å£
```python
from abc import ABC, abstractmethod
from typing import Optional, Dict, Any, Callable
import tkinter as tk
from tkinter import ttk

class BaseFunctionModule(ABC):
    """
    åŠŸèƒ½æ¨¡å—åŸºç±»
    å®šä¹‰äº†æ‰€æœ‰åŠŸèƒ½æ¨¡å—å¿…é¡»å®ç°çš„æ¥å£
    """
    
    def __init__(self, name: str, display_name: str, description: str = "", icon: str = "â“"):
        self.name = name
        self.display_name = display_name
        self.description = description
        self.icon = icon
        self.is_active = False
        self.is_running = False
        
        # å›è°ƒå‡½æ•°
        self.progress_callback: Optional[Callable[[float, str], None]] = None
        self.log_callback: Optional[Callable[[str, str], None]] = None
        self.ui_update_callback: Optional[Callable[[str, Any], None]] = None

    @abstractmethod
    def create_settings_ui(self, parent) -> Optional[ttk.Frame]:
        """
        åˆ›å»ºå¹¶è¿”å›åŠŸèƒ½å¯¹åº”çš„"è®¾ç½®"UIé¢æ¿
        
        Args:
            parent: çˆ¶å®¹å™¨
            
        Returns:
            ttk.Frame: è®¾ç½®UIé¢æ¿ï¼Œå¦‚æœä¸éœ€è¦åˆ™è¿”å›None
        """
        pass

    @abstractmethod
    def create_workspace_ui(self, parent) -> Optional[ttk.Frame]:
        """
        åˆ›å»ºå¹¶è¿”å›åŠŸèƒ½å¯¹åº”çš„"å·¥ä½œåŒº"UIé¢æ¿
        
        Args:
            parent: çˆ¶å®¹å™¨
            
        Returns:
            ttk.Frame: å·¥ä½œåŒºUIé¢æ¿ï¼Œå¦‚æœä¸éœ€è¦åˆ™è¿”å›None
        """
        pass

    @abstractmethod
    def execute(self, params: Dict[str, Any]):
        """
        æ‰§è¡ŒåŠŸèƒ½çš„æ ¸å¿ƒé€»è¾‘
        
        Args:
            params: æ‰§è¡Œå‚æ•°
        """
        pass

    @abstractmethod
    def stop_execution(self):
        """
        åœæ­¢æ­£åœ¨æ‰§è¡Œçš„æ“ä½œ
        """
        pass

    def set_callbacks(self, progress_callback=None, log_callback=None, ui_update_callback=None):
        """
        è®¾ç½®å›è°ƒå‡½æ•°ä»¥ä¸ä¸»UIé€šä¿¡
        
        Args:
            progress_callback: è¿›åº¦æ›´æ–°å›è°ƒ
            log_callback: æ—¥å¿—æ¶ˆæ¯å›è°ƒ
            ui_update_callback: UIæ›´æ–°å›è°ƒ
        """
        self.progress_callback = progress_callback
        self.log_callback = log_callback
        self.ui_update_callback = ui_update_callback

    def on_activate(self):
        """åŠŸèƒ½è¢«æ¿€æ´»æ—¶çš„å›è°ƒ"""
        self.is_active = True
        if self.log_callback:
            self.log_callback(f"æ¨¡å— '{self.display_name}' å·²æ¿€æ´»", "info")

    def on_deactivate(self):
        """åŠŸèƒ½è¢«åœç”¨æ—¶çš„å›è°ƒ"""
        self.is_active = False
```

### 1.2 FunctionManageræ¥å£
```python
from typing import Dict, Optional, List
from .base_module import BaseFunctionModule

class FunctionManager:
    """
    åŠŸèƒ½ç®¡ç†å™¨
    è´Ÿè´£åŠŸèƒ½æ¨¡å—çš„æ³¨å†Œã€æ¿€æ´»å’Œç®¡ç†
    """
    
    def __init__(self):
        self.modules: Dict[str, BaseFunctionModule] = {}
        self.active_module: Optional[BaseFunctionModule] = None

    def register_module(self, module: BaseFunctionModule) -> bool:
        """
        æ³¨å†ŒåŠŸèƒ½æ¨¡å—
        
        Args:
            module: åŠŸèƒ½æ¨¡å—å®ä¾‹
            
        Returns:
            bool: æ³¨å†Œæ˜¯å¦æˆåŠŸ
        """
        if module.name in self.modules:
            return False
        self.modules[module.name] = module
        return True

    def unregister_module(self, name: str) -> bool:
        """
        æ³¨é”€åŠŸèƒ½æ¨¡å—
        
        Args:
            name: æ¨¡å—åç§°
            
        Returns:
            bool: æ³¨é”€æ˜¯å¦æˆåŠŸ
        """
        if name in self.modules:
            del self.modules[name]
            return True
        return False

    def activate_module(self, name: str) -> bool:
        """
        æ¿€æ´»æŒ‡å®šåŠŸèƒ½æ¨¡å—
        
        Args:
            name: æ¨¡å—åç§°
            
        Returns:
            bool: æ¿€æ´»æ˜¯å¦æˆåŠŸ
        """
        if name not in self.modules:
            return False

        if self.active_module and self.active_module.name != name:
            self.active_module.on_deactivate()

        self.active_module = self.modules[name]
        self.active_module.on_activate()
        return True

    def deactivate_module(self) -> bool:
        """
        åœç”¨å½“å‰æ¿€æ´»çš„æ¨¡å—
        
        Returns:
            bool: åœç”¨æ˜¯å¦æˆåŠŸ
        """
        if self.active_module:
            self.active_module.on_deactivate()
            self.active_module = None
            return True
        return False

    def get_module_names(self) -> List[str]:
        """
        è·å–æ‰€æœ‰æ¨¡å—åç§°
        
        Returns:
            List[str]: æ¨¡å—åç§°åˆ—è¡¨
        """
        return list(self.modules.keys())

    def get_module(self, name: str) -> Optional[BaseFunctionModule]:
        """
        è·å–æŒ‡å®šæ¨¡å—
        
        Args:
            name: æ¨¡å—åç§°
            
        Returns:
            BaseFunctionModule: æ¨¡å—å®ä¾‹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›None
        """
        return self.modules.get(name)

    def get_active_module(self) -> Optional[BaseFunctionModule]:
        """
        è·å–å½“å‰æ¿€æ´»çš„æ¨¡å—
        
        Returns:
            BaseFunctionModule: å½“å‰æ¿€æ´»çš„æ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›None
        """
        return self.active_module
```

## 2. UIæ¨¡å—æ¥å£

### 2.1 MainWindowæ¥å£
```python
import tkinter as tk
from typing import Dict, Any
from core.function_manager import FunctionManager

class MainWindowInterface:
    """
    ä¸»çª—å£æ¥å£
    å®šä¹‰ä¸»çª—å£å¿…é¡»å®ç°çš„æ–¹æ³•
    """
    
    def __init__(self, root: tk.Tk):
        self.root = root
        self.function_manager = FunctionManager()
        
    def setup_ui(self):
        """è®¾ç½®ç”¨æˆ·ç•Œé¢"""
        pass
        
    def update_ui_for_module(self, module):
        """æ›´æ–°ç•Œé¢ä»¥åæ˜ å½“å‰æ¨¡å—"""
        pass
        
    def show_message(self, title: str, message: str, msg_type: str = "info"):
        """
        æ˜¾ç¤ºæ¶ˆæ¯å¯¹è¯æ¡†
        
        Args:
            title: æ ‡é¢˜
            message: æ¶ˆæ¯å†…å®¹
            msg_type: æ¶ˆæ¯ç±»å‹ (info, warning, error)
        """
        pass
```

### 2.2 UIç»„ä»¶æ¥å£

#### 2.2.1 FunctionCardæ¥å£
```python
import tkinter as tk
from tkinter import ttk
from core.base_module import BaseFunctionModule

class FunctionCardInterface:
    """
    åŠŸèƒ½å¡ç‰‡æ¥å£
    """
    
    def __init__(self, parent: ttk.Frame, module: BaseFunctionModule):
        self.parent = parent
        self.module = module
        self.card_frame: ttk.Frame = None
        
    def create_card(self) -> ttk.Frame:
        """
        åˆ›å»ºåŠŸèƒ½å¡ç‰‡
        
        Returns:
            ttk.Frame: å¡ç‰‡æ¡†æ¶
        """
        pass
        
    def bind_events(self, callback):
        """
        ç»‘å®šäº‹ä»¶
        
        Args:
            callback: å›è°ƒå‡½æ•°
        """
        pass
        
    def update_selection_state(self, is_selected: bool):
        """
        æ›´æ–°é€‰ä¸­çŠ¶æ€
        
        Args:
            is_selected: æ˜¯å¦é€‰ä¸­
        """
        pass
```

#### 2.2.2 ImageVieweræ¥å£
```python
import tkinter as tk
from tkinter import ttk

class ImageViewerInterface:
    """
    å›¾ç‰‡æŸ¥çœ‹å™¨æ¥å£
    """
    
    def __init__(self, parent: ttk.Frame):
        self.parent = parent
        self.viewer_frame: ttk.Frame = None
        
    def create_viewer(self) -> ttk.Frame:
        """
        åˆ›å»ºå›¾ç‰‡æŸ¥çœ‹å™¨
        
        Returns:
            ttk.Frame: æŸ¥çœ‹å™¨æ¡†æ¶
        """
        pass
        
    def load_image(self, file_path: str):
        """
        åŠ è½½å›¾ç‰‡
        
        Args:
            file_path: å›¾ç‰‡æ–‡ä»¶è·¯å¾„
        """
        pass
        
    def zoom_in(self):
        """æ”¾å¤§"""
        pass
        
    def zoom_out(self):
        """ç¼©å°"""
        pass
        
    def reset_zoom(self):
        """é‡ç½®ç¼©æ”¾"""
        pass
```

## 3. åŠŸèƒ½æ¨¡å—æ¥å£

### 3.1 å›¾ç‰‡å»é‡æ¨¡å—æ¥å£

#### 3.1.1 DeduplicationModuleæ¥å£
```python
from core.base_module import BaseFunctionModule
from typing import Dict, Any, List

class DeduplicationModuleInterface(BaseFunctionModule):
    """
    å›¾ç‰‡å»é‡æ¨¡å—æ¥å£
    """
    
    def __init__(self):
        super().__init__(
            name="deduplication",
            display_name="Image Deduplication",
            description="Find and process duplicate or similar images.",
            icon="ğŸ”"
        )
        self.duplicate_groups: Dict[str, List[str]] = {}
        self.selected_files: set = set()
        
    def create_settings_ui(self, parent) -> ttk.Frame:
        """åˆ›å»ºè®¾ç½®UIé¢æ¿"""
        pass
        
    def create_workspace_ui(self, parent) -> ttk.Frame:
        """åˆ›å»ºå·¥ä½œåŒºUIé¢æ¿"""
        pass
        
    def execute(self, params: Dict[str, Any]):
        """æ‰§è¡Œå»é‡æ“ä½œ"""
        pass
        
    def stop_execution(self):
        """åœæ­¢æ‰§è¡Œ"""
        pass
        
    def select_files(self, file_paths: List[str]):
        """
        é€‰æ‹©æ–‡ä»¶
        
        Args:
            file_paths: æ–‡ä»¶è·¯å¾„åˆ—è¡¨
        """
        pass
        
    def unselect_files(self, file_paths: List[str]):
        """
        å–æ¶ˆé€‰æ‹©æ–‡ä»¶
        
        Args:
            file_paths: æ–‡ä»¶è·¯å¾„åˆ—è¡¨
        """
        pass
        
    def delete_selected_files(self):
        """åˆ é™¤é€‰ä¸­çš„æ–‡ä»¶"""
        pass
        
    def move_selected_files(self, target_dir: str):
        """
        ç§»åŠ¨é€‰ä¸­çš„æ–‡ä»¶
        
        Args:
            target_dir: ç›®æ ‡ç›®å½•
        """
        pass
```

#### 3.1.2 DeduplicationUIæ¥å£
```python
from tkinter import ttk
from typing import Dict, List

class DeduplicationUIInterface:
    """
    å›¾ç‰‡å»é‡UIæ¥å£
    """
    
    def create_settings_panel(self, parent) -> ttk.Frame:
        """
        åˆ›å»ºè®¾ç½®é¢æ¿
        
        Args:
            parent: çˆ¶å®¹å™¨
            
        Returns:
            ttk.Frame: è®¾ç½®é¢æ¿
        """
        pass
        
    def create_workspace_panel(self, parent) -> ttk.Frame:
        """
        åˆ›å»ºå·¥ä½œåŒºé¢æ¿
        
        Args:
            parent: çˆ¶å®¹å™¨
            
        Returns:
            ttk.Frame: å·¥ä½œåŒºé¢æ¿
        """
        pass
        
    def update_progress(self, value: float, message: str = ""):
        """
        æ›´æ–°è¿›åº¦
        
        Args:
            value: è¿›åº¦å€¼ (0-100)
            message: è¿›åº¦æ¶ˆæ¯
        """
        pass
        
    def display_results(self, duplicates: Dict[str, List[str]]):
        """
        æ˜¾ç¤ºç»“æœ
        
        Args:
            duplicates: é‡å¤æ–‡ä»¶ç»„
        """
        pass
```

#### 3.1.3 DeduplicationLogicæ¥å£
```python
from typing import Dict, List, Tuple
import imagehash

class DeduplicationLogicInterface:
    """
    å›¾ç‰‡å»é‡é€»è¾‘æ¥å£
    """
    
    def find_duplicates(self, file_paths: List[str], threshold: float) -> Dict[str, List[str]]:
        """
        æŸ¥æ‰¾é‡å¤å›¾ç‰‡
        
        Args:
            file_paths: æ–‡ä»¶è·¯å¾„åˆ—è¡¨
            threshold: ç›¸ä¼¼åº¦é˜ˆå€¼
            
        Returns:
            Dict[str, List[str]]: é‡å¤æ–‡ä»¶ç»„
        """
        pass
        
    def calculate_image_hash(self, file_path: str) -> imagehash.ImageHash:
        """
        è®¡ç®—å›¾ç‰‡å“ˆå¸Œå€¼
        
        Args:
            file_path: æ–‡ä»¶è·¯å¾„
            
        Returns:
            imagehash.ImageHash: å›¾ç‰‡å“ˆå¸Œå€¼
        """
        pass
        
    def calculate_similarity(self, hash1: imagehash.ImageHash, hash2: imagehash.ImageHash) -> float:
        """
        è®¡ç®—ä¸¤ä¸ªå“ˆå¸Œå€¼çš„ç›¸ä¼¼åº¦
        
        Args:
            hash1: ç¬¬ä¸€ä¸ªå“ˆå¸Œå€¼
            hash2: ç¬¬äºŒä¸ªå“ˆå¸Œå€¼
            
        Returns:
            float: ç›¸ä¼¼åº¦ (0-1)
        """
        pass
```

### 3.2 AVIFè½¬æ¢æ¨¡å—æ¥å£

#### 3.2.1 AVIFConverterModuleæ¥å£
```python
from core.base_module import BaseFunctionModule
from typing import Dict, Any

class AVIFConverterModuleInterface(BaseFunctionModule):
    """
    AVIFè½¬æ¢æ¨¡å—æ¥å£
    """
    
    def __init__(self):
        super().__init__(
            name="avif_converter",
            display_name="AVIF Converter",
            description="Convert images to AVIF format to save storage space.",
            icon="ğŸ”„"
        )
        
    def create_settings_ui(self, parent) -> ttk.Frame:
        """åˆ›å»ºè®¾ç½®UIé¢æ¿"""
        pass
        
    def create_workspace_ui(self, parent) -> ttk.Frame:
        """åˆ›å»ºå·¥ä½œåŒºUIé¢æ¿"""
        pass
        
    def execute(self, params: Dict[str, Any]):
        """æ‰§è¡Œè½¬æ¢æ“ä½œ"""
        pass
        
    def stop_execution(self):
        """åœæ­¢æ‰§è¡Œ"""
        pass
```

## 4. å·¥å…·æ¨¡å—æ¥å£

### 4.1 ImageCacheæ¥å£
```python
from typing import Optional, Tuple
from PIL import Image

class ImageCacheInterface:
    """
    å›¾ç‰‡ç¼“å­˜æ¥å£
    """
    
    def __init__(self, max_size: int = 100):
        self.max_size = max_size
        
    def get_image(self, file_path: str, size: Tuple[int, int]) -> Optional[Image.Image]:
        """
        è·å–å›¾ç‰‡
        
        Args:
            file_path: æ–‡ä»¶è·¯å¾„
            size: å›¾ç‰‡å°ºå¯¸
            
        Returns:
            Image.Image: å›¾ç‰‡å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›None
        """
        pass
        
    def put_image(self, file_path: str, size: Tuple[int, int], image: Image.Image):
        """
        å­˜å‚¨å›¾ç‰‡
        
        Args:
            file_path: æ–‡ä»¶è·¯å¾„
            size: å›¾ç‰‡å°ºå¯¸
            image: å›¾ç‰‡å¯¹è±¡
        """
        pass
        
    def clear(self):
        """æ¸…ç©ºç¼“å­˜"""
        pass
        
    def get_cache_size(self) -> int:
        """
        è·å–ç¼“å­˜å¤§å°
        
        Returns:
            int: ç¼“å­˜ä¸­å›¾ç‰‡æ•°é‡
        """
        pass
```

### 4.2 ImageUtilsæ¥å£
```python
from typing import Tuple
from PIL import Image
import imagehash

class ImageUtilsInterface:
    """
    å›¾ç‰‡å¤„ç†å·¥å…·æ¥å£
    """
    
    @staticmethod
    def calculate_hash(file_path: str) -> imagehash.ImageHash:
        """
        è®¡ç®—å›¾ç‰‡å“ˆå¸Œå€¼
        
        Args:
            file_path: æ–‡ä»¶è·¯å¾„
            
        Returns:
            imagehash.ImageHash: å›¾ç‰‡å“ˆå¸Œå€¼
        """
        pass
        
    @staticmethod
    def get_thumbnail(file_path: str, size: Tuple[int, int]) -> Image.Image:
        """
        è·å–ç¼©ç•¥å›¾
        
        Args:
            file_path: æ–‡ä»¶è·¯å¾„
            size: ç¼©ç•¥å›¾å°ºå¯¸
            
        Returns:
            Image.Image: ç¼©ç•¥å›¾
        """
        pass
        
    @staticmethod
    def resize_image(image: Image.Image, size: Tuple[int, int]) -> Image.Image:
        """
        è°ƒæ•´å›¾ç‰‡å°ºå¯¸
        
        Args:
            image: åŸå§‹å›¾ç‰‡
            size: ç›®æ ‡å°ºå¯¸
            
        Returns:
            Image.Image: è°ƒæ•´åçš„å›¾ç‰‡
        """
        pass
        
    @staticmethod
    def convert_to_avif(file_path: str, target_path: str, quality: int = 85):
        """
        è½¬æ¢ä¸ºAVIFæ ¼å¼
        
        Args:
            file_path: æºæ–‡ä»¶è·¯å¾„
            target_path: ç›®æ ‡æ–‡ä»¶è·¯å¾„
            quality: è´¨é‡ (1-100)
        """
        pass
```

## 5. ä¾èµ–å…³ç³»

### 5.1 æ¨¡å—ä¾èµ–å›¾
```
main.py
â”œâ”€â”€ ui.main_window
â”‚   â”œâ”€â”€ core.function_manager
â”‚   â”œâ”€â”€ ui.components.*
â”‚   â””â”€â”€ ui.themes.theme_manager
â”œâ”€â”€ core.function_manager
â”‚   â””â”€â”€ core.base_module
â”œâ”€â”€ modules.*
â”‚   â”œâ”€â”€ core.base_module
â”‚   â”œâ”€â”€ ui.components.*
â”‚   â”œâ”€â”€ utils.*
â”‚   â””â”€â”€ core.callbacks
â””â”€â”€ utils.*
    â””â”€â”€ (ç¬¬ä¸‰æ–¹åº“: PIL, imagehash, tkinter)
```

### 5.2 ä¾èµ–æ³¨å…¥é…ç½®
```python
# core/dependency_injector.py
from typing import Dict, Type, Any

class DependencyInjector:
    """
    ä¾èµ–æ³¨å…¥å™¨
    """
    
    def __init__(self):
        self._services: Dict[str, Any] = {}
        self._singletons: Dict[str, Any] = {}
        
    def register(self, name: str, service: Any, singleton: bool = False):
        """
        æ³¨å†ŒæœåŠ¡
        
        Args:
            name: æœåŠ¡åç§°
            service: æœåŠ¡å®ä¾‹æˆ–ç±»
            singleton: æ˜¯å¦ä¸ºå•ä¾‹
        """
        if singleton:
            self._singletons[name] = service
        else:
            self._services[name] = service
            
    def get(self, name: str) -> Any:
        """
        è·å–æœåŠ¡
        
        Args:
            name: æœåŠ¡åç§°
            
        Returns:
            Any: æœåŠ¡å®ä¾‹
        """
        if name in self._singletons:
            if isinstance(self._singletons[name], type):
                self._singletons[name] = self._singletons[name]()
            return self._singletons[name]
        elif name in self._services:
            service = self._services[name]
            if isinstance(service, type):
                return service()
            return service
        else:
            raise KeyError(f"Service '{name}' not found")
            
    def inject(self, cls: Type) -> Any:
        """
        æ³¨å…¥ä¾èµ–å¹¶åˆ›å»ºå®ä¾‹
        
        Args:
            cls: ç±»
            
        Returns:
            Any: å®ä¾‹
        """
        # è¿™é‡Œå¯ä»¥å®ç°æ›´å¤æ‚çš„ä¾èµ–æ³¨å…¥é€»è¾‘
        return cls()
```

### 5.3 é…ç½®ç®¡ç†
```python
# core/config.py
from typing import Dict, Any
import json
import os

class ConfigManager:
    """
    é…ç½®ç®¡ç†å™¨
    """
    
    def __init__(self, config_file: str = "config.json"):
        self.config_file = config_file
        self.config: Dict[str, Any] = self._load_config()
        
    def _load_config(self) -> Dict[str, Any]:
        """
        åŠ è½½é…ç½®
        
        Returns:
            Dict[str, Any]: é…ç½®å­—å…¸
        """
        if os.path.exists(self.config_file):
            with open(self.config_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        return self._get_default_config()
        
    def _get_default_config(self) -> Dict[str, Any]:
        """
        è·å–é»˜è®¤é…ç½®
        
        Returns:
            Dict[str, Any]: é»˜è®¤é…ç½®
        """
        return {
            "theme": "dark",
            "language": "zh_CN",
            "thumbnail_size": 80,
            "scan_subdirs": True,
            "similarity_threshold": 95
        }
        
    def get(self, key: str, default=None) -> Any:
        """
        è·å–é…ç½®å€¼
        
        Args:
            key: é…ç½®é”®
            default: é»˜è®¤å€¼
            
        Returns:
            Any: é…ç½®å€¼
        """
        return self.config.get(key, default)
        
    def set(self, key: str, value: Any):
        """
        è®¾ç½®é…ç½®å€¼
        
        Args:
            key: é…ç½®é”®
            value: é…ç½®å€¼
        """
        self.config[key] = value
        self._save_config()
        
    def _save_config(self):
        """ä¿å­˜é…ç½®"""
        with open(self.config_file, 'w', encoding='utf-8') as f:
            json.dump(self.config, f, ensure_ascii=False, indent=2)
```

é€šè¿‡ä»¥ä¸Šæ¥å£å’Œä¾èµ–å…³ç³»å®šä¹‰ï¼Œæˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªæ¸…æ™°ã€æ¨¡å—åŒ–çš„æ¶æ„ï¼Œä¸ºåç»­çš„ä»£ç æ‹†åˆ†å’ŒPyQt6é‡æ„å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚