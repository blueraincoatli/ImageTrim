# 模块接口和依赖关系定义

## 1. 核心模块接口

### 1.1 BaseFunctionModule接口
```python
from abc import ABC, abstractmethod
from typing import Optional, Dict, Any, Callable
import tkinter as tk
from tkinter import ttk

class BaseFunctionModule(ABC):
    """
    功能模块基类
    定义了所有功能模块必须实现的接口
    """
    
    def __init__(self, name: str, display_name: str, description: str = "", icon: str = "❓"):
        self.name = name
        self.display_name = display_name
        self.description = description
        self.icon = icon
        self.is_active = False
        self.is_running = False
        
        # 回调函数
        self.progress_callback: Optional[Callable[[float, str], None]] = None
        self.log_callback: Optional[Callable[[str, str], None]] = None
        self.ui_update_callback: Optional[Callable[[str, Any], None]] = None

    @abstractmethod
    def create_settings_ui(self, parent) -> Optional[ttk.Frame]:
        """
        创建并返回功能对应的"设置"UI面板
        
        Args:
            parent: 父容器
            
        Returns:
            ttk.Frame: 设置UI面板，如果不需要则返回None
        """
        pass

    @abstractmethod
    def create_workspace_ui(self, parent) -> Optional[ttk.Frame]:
        """
        创建并返回功能对应的"工作区"UI面板
        
        Args:
            parent: 父容器
            
        Returns:
            ttk.Frame: 工作区UI面板，如果不需要则返回None
        """
        pass

    @abstractmethod
    def execute(self, params: Dict[str, Any]):
        """
        执行功能的核心逻辑
        
        Args:
            params: 执行参数
        """
        pass

    @abstractmethod
    def stop_execution(self):
        """
        停止正在执行的操作
        """
        pass

    def set_callbacks(self, progress_callback=None, log_callback=None, ui_update_callback=None):
        """
        设置回调函数以与主UI通信
        
        Args:
            progress_callback: 进度更新回调
            log_callback: 日志消息回调
            ui_update_callback: UI更新回调
        """
        self.progress_callback = progress_callback
        self.log_callback = log_callback
        self.ui_update_callback = ui_update_callback

    def on_activate(self):
        """功能被激活时的回调"""
        self.is_active = True
        if self.log_callback:
            self.log_callback(f"模块 '{self.display_name}' 已激活", "info")

    def on_deactivate(self):
        """功能被停用时的回调"""
        self.is_active = False
```

### 1.2 FunctionManager接口
```python
from typing import Dict, Optional, List
from .base_module import BaseFunctionModule

class FunctionManager:
    """
    功能管理器
    负责功能模块的注册、激活和管理
    """
    
    def __init__(self):
        self.modules: Dict[str, BaseFunctionModule] = {}
        self.active_module: Optional[BaseFunctionModule] = None

    def register_module(self, module: BaseFunctionModule) -> bool:
        """
        注册功能模块
        
        Args:
            module: 功能模块实例
            
        Returns:
            bool: 注册是否成功
        """
        if module.name in self.modules:
            return False
        self.modules[module.name] = module
        return True

    def unregister_module(self, name: str) -> bool:
        """
        注销功能模块
        
        Args:
            name: 模块名称
            
        Returns:
            bool: 注销是否成功
        """
        if name in self.modules:
            del self.modules[name]
            return True
        return False

    def activate_module(self, name: str) -> bool:
        """
        激活指定功能模块
        
        Args:
            name: 模块名称
            
        Returns:
            bool: 激活是否成功
        """
        if name not in self.modules:
            return False

        if self.active_module and self.active_module.name != name:
            self.active_module.on_deactivate()

        self.active_module = self.modules[name]
        self.active_module.on_activate()
        return True

    def deactivate_module(self) -> bool:
        """
        停用当前激活的模块
        
        Returns:
            bool: 停用是否成功
        """
        if self.active_module:
            self.active_module.on_deactivate()
            self.active_module = None
            return True
        return False

    def get_module_names(self) -> List[str]:
        """
        获取所有模块名称
        
        Returns:
            List[str]: 模块名称列表
        """
        return list(self.modules.keys())

    def get_module(self, name: str) -> Optional[BaseFunctionModule]:
        """
        获取指定模块
        
        Args:
            name: 模块名称
            
        Returns:
            BaseFunctionModule: 模块实例，如果不存在则返回None
        """
        return self.modules.get(name)

    def get_active_module(self) -> Optional[BaseFunctionModule]:
        """
        获取当前激活的模块
        
        Returns:
            BaseFunctionModule: 当前激活的模块，如果没有则返回None
        """
        return self.active_module
```

## 2. UI模块接口

### 2.1 MainWindow接口
```python
import tkinter as tk
from typing import Dict, Any
from core.function_manager import FunctionManager

class MainWindowInterface:
    """
    主窗口接口
    定义主窗口必须实现的方法
    """
    
    def __init__(self, root: tk.Tk):
        self.root = root
        self.function_manager = FunctionManager()
        
    def setup_ui(self):
        """设置用户界面"""
        pass
        
    def update_ui_for_module(self, module):
        """更新界面以反映当前模块"""
        pass
        
    def show_message(self, title: str, message: str, msg_type: str = "info"):
        """
        显示消息对话框
        
        Args:
            title: 标题
            message: 消息内容
            msg_type: 消息类型 (info, warning, error)
        """
        pass
```

### 2.2 UI组件接口

#### 2.2.1 FunctionCard接口
```python
import tkinter as tk
from tkinter import ttk
from core.base_module import BaseFunctionModule

class FunctionCardInterface:
    """
    功能卡片接口
    """
    
    def __init__(self, parent: ttk.Frame, module: BaseFunctionModule):
        self.parent = parent
        self.module = module
        self.card_frame: ttk.Frame = None
        
    def create_card(self) -> ttk.Frame:
        """
        创建功能卡片
        
        Returns:
            ttk.Frame: 卡片框架
        """
        pass
        
    def bind_events(self, callback):
        """
        绑定事件
        
        Args:
            callback: 回调函数
        """
        pass
        
    def update_selection_state(self, is_selected: bool):
        """
        更新选中状态
        
        Args:
            is_selected: 是否选中
        """
        pass
```

#### 2.2.2 ImageViewer接口
```python
import tkinter as tk
from tkinter import ttk

class ImageViewerInterface:
    """
    图片查看器接口
    """
    
    def __init__(self, parent: ttk.Frame):
        self.parent = parent
        self.viewer_frame: ttk.Frame = None
        
    def create_viewer(self) -> ttk.Frame:
        """
        创建图片查看器
        
        Returns:
            ttk.Frame: 查看器框架
        """
        pass
        
    def load_image(self, file_path: str):
        """
        加载图片
        
        Args:
            file_path: 图片文件路径
        """
        pass
        
    def zoom_in(self):
        """放大"""
        pass
        
    def zoom_out(self):
        """缩小"""
        pass
        
    def reset_zoom(self):
        """重置缩放"""
        pass
```

## 3. 功能模块接口

### 3.1 图片去重模块接口

#### 3.1.1 DeduplicationModule接口
```python
from core.base_module import BaseFunctionModule
from typing import Dict, Any, List

class DeduplicationModuleInterface(BaseFunctionModule):
    """
    图片去重模块接口
    """
    
    def __init__(self):
        super().__init__(
            name="deduplication",
            display_name="Image Deduplication",
            description="Find and process duplicate or similar images.",
            icon="🔍"
        )
        self.duplicate_groups: Dict[str, List[str]] = {}
        self.selected_files: set = set()
        
    def create_settings_ui(self, parent) -> ttk.Frame:
        """创建设置UI面板"""
        pass
        
    def create_workspace_ui(self, parent) -> ttk.Frame:
        """创建工作区UI面板"""
        pass
        
    def execute(self, params: Dict[str, Any]):
        """执行去重操作"""
        pass
        
    def stop_execution(self):
        """停止执行"""
        pass
        
    def select_files(self, file_paths: List[str]):
        """
        选择文件
        
        Args:
            file_paths: 文件路径列表
        """
        pass
        
    def unselect_files(self, file_paths: List[str]):
        """
        取消选择文件
        
        Args:
            file_paths: 文件路径列表
        """
        pass
        
    def delete_selected_files(self):
        """删除选中的文件"""
        pass
        
    def move_selected_files(self, target_dir: str):
        """
        移动选中的文件
        
        Args:
            target_dir: 目标目录
        """
        pass
```

#### 3.1.2 DeduplicationUI接口
```python
from tkinter import ttk
from typing import Dict, List

class DeduplicationUIInterface:
    """
    图片去重UI接口
    """
    
    def create_settings_panel(self, parent) -> ttk.Frame:
        """
        创建设置面板
        
        Args:
            parent: 父容器
            
        Returns:
            ttk.Frame: 设置面板
        """
        pass
        
    def create_workspace_panel(self, parent) -> ttk.Frame:
        """
        创建工作区面板
        
        Args:
            parent: 父容器
            
        Returns:
            ttk.Frame: 工作区面板
        """
        pass
        
    def update_progress(self, value: float, message: str = ""):
        """
        更新进度
        
        Args:
            value: 进度值 (0-100)
            message: 进度消息
        """
        pass
        
    def display_results(self, duplicates: Dict[str, List[str]]):
        """
        显示结果
        
        Args:
            duplicates: 重复文件组
        """
        pass
```

#### 3.1.3 DeduplicationLogic接口
```python
from typing import Dict, List, Tuple
import imagehash

class DeduplicationLogicInterface:
    """
    图片去重逻辑接口
    """
    
    def find_duplicates(self, file_paths: List[str], threshold: float) -> Dict[str, List[str]]:
        """
        查找重复图片
        
        Args:
            file_paths: 文件路径列表
            threshold: 相似度阈值
            
        Returns:
            Dict[str, List[str]]: 重复文件组
        """
        pass
        
    def calculate_image_hash(self, file_path: str) -> imagehash.ImageHash:
        """
        计算图片哈希值
        
        Args:
            file_path: 文件路径
            
        Returns:
            imagehash.ImageHash: 图片哈希值
        """
        pass
        
    def calculate_similarity(self, hash1: imagehash.ImageHash, hash2: imagehash.ImageHash) -> float:
        """
        计算两个哈希值的相似度
        
        Args:
            hash1: 第一个哈希值
            hash2: 第二个哈希值
            
        Returns:
            float: 相似度 (0-1)
        """
        pass
```

### 3.2 AVIF转换模块接口

#### 3.2.1 AVIFConverterModule接口
```python
from core.base_module import BaseFunctionModule
from typing import Dict, Any

class AVIFConverterModuleInterface(BaseFunctionModule):
    """
    AVIF转换模块接口
    """
    
    def __init__(self):
        super().__init__(
            name="avif_converter",
            display_name="AVIF Converter",
            description="Convert images to AVIF format to save storage space.",
            icon="🔄"
        )
        
    def create_settings_ui(self, parent) -> ttk.Frame:
        """创建设置UI面板"""
        pass
        
    def create_workspace_ui(self, parent) -> ttk.Frame:
        """创建工作区UI面板"""
        pass
        
    def execute(self, params: Dict[str, Any]):
        """执行转换操作"""
        pass
        
    def stop_execution(self):
        """停止执行"""
        pass
```

## 4. 工具模块接口

### 4.1 ImageCache接口
```python
from typing import Optional, Tuple
from PIL import Image

class ImageCacheInterface:
    """
    图片缓存接口
    """
    
    def __init__(self, max_size: int = 100):
        self.max_size = max_size
        
    def get_image(self, file_path: str, size: Tuple[int, int]) -> Optional[Image.Image]:
        """
        获取图片
        
        Args:
            file_path: 文件路径
            size: 图片尺寸
            
        Returns:
            Image.Image: 图片对象，如果不存在则返回None
        """
        pass
        
    def put_image(self, file_path: str, size: Tuple[int, int], image: Image.Image):
        """
        存储图片
        
        Args:
            file_path: 文件路径
            size: 图片尺寸
            image: 图片对象
        """
        pass
        
    def clear(self):
        """清空缓存"""
        pass
        
    def get_cache_size(self) -> int:
        """
        获取缓存大小
        
        Returns:
            int: 缓存中图片数量
        """
        pass
```

### 4.2 ImageUtils接口
```python
from typing import Tuple
from PIL import Image
import imagehash

class ImageUtilsInterface:
    """
    图片处理工具接口
    """
    
    @staticmethod
    def calculate_hash(file_path: str) -> imagehash.ImageHash:
        """
        计算图片哈希值
        
        Args:
            file_path: 文件路径
            
        Returns:
            imagehash.ImageHash: 图片哈希值
        """
        pass
        
    @staticmethod
    def get_thumbnail(file_path: str, size: Tuple[int, int]) -> Image.Image:
        """
        获取缩略图
        
        Args:
            file_path: 文件路径
            size: 缩略图尺寸
            
        Returns:
            Image.Image: 缩略图
        """
        pass
        
    @staticmethod
    def resize_image(image: Image.Image, size: Tuple[int, int]) -> Image.Image:
        """
        调整图片尺寸
        
        Args:
            image: 原始图片
            size: 目标尺寸
            
        Returns:
            Image.Image: 调整后的图片
        """
        pass
        
    @staticmethod
    def convert_to_avif(file_path: str, target_path: str, quality: int = 85):
        """
        转换为AVIF格式
        
        Args:
            file_path: 源文件路径
            target_path: 目标文件路径
            quality: 质量 (1-100)
        """
        pass
```

## 5. 依赖关系

### 5.1 模块依赖图
```
main.py
├── ui.main_window
│   ├── core.function_manager
│   ├── ui.components.*
│   └── ui.themes.theme_manager
├── core.function_manager
│   └── core.base_module
├── modules.*
│   ├── core.base_module
│   ├── ui.components.*
│   ├── utils.*
│   └── core.callbacks
└── utils.*
    └── (第三方库: PIL, imagehash, tkinter)
```

### 5.2 依赖注入配置
```python
# core/dependency_injector.py
from typing import Dict, Type, Any

class DependencyInjector:
    """
    依赖注入器
    """
    
    def __init__(self):
        self._services: Dict[str, Any] = {}
        self._singletons: Dict[str, Any] = {}
        
    def register(self, name: str, service: Any, singleton: bool = False):
        """
        注册服务
        
        Args:
            name: 服务名称
            service: 服务实例或类
            singleton: 是否为单例
        """
        if singleton:
            self._singletons[name] = service
        else:
            self._services[name] = service
            
    def get(self, name: str) -> Any:
        """
        获取服务
        
        Args:
            name: 服务名称
            
        Returns:
            Any: 服务实例
        """
        if name in self._singletons:
            if isinstance(self._singletons[name], type):
                self._singletons[name] = self._singletons[name]()
            return self._singletons[name]
        elif name in self._services:
            service = self._services[name]
            if isinstance(service, type):
                return service()
            return service
        else:
            raise KeyError(f"Service '{name}' not found")
            
    def inject(self, cls: Type) -> Any:
        """
        注入依赖并创建实例
        
        Args:
            cls: 类
            
        Returns:
            Any: 实例
        """
        # 这里可以实现更复杂的依赖注入逻辑
        return cls()
```

### 5.3 配置管理
```python
# core/config.py
from typing import Dict, Any
import json
import os

class ConfigManager:
    """
    配置管理器
    """
    
    def __init__(self, config_file: str = "config.json"):
        self.config_file = config_file
        self.config: Dict[str, Any] = self._load_config()
        
    def _load_config(self) -> Dict[str, Any]:
        """
        加载配置
        
        Returns:
            Dict[str, Any]: 配置字典
        """
        if os.path.exists(self.config_file):
            with open(self.config_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        return self._get_default_config()
        
    def _get_default_config(self) -> Dict[str, Any]:
        """
        获取默认配置
        
        Returns:
            Dict[str, Any]: 默认配置
        """
        return {
            "theme": "dark",
            "language": "zh_CN",
            "thumbnail_size": 80,
            "scan_subdirs": True,
            "similarity_threshold": 95
        }
        
    def get(self, key: str, default=None) -> Any:
        """
        获取配置值
        
        Args:
            key: 配置键
            default: 默认值
            
        Returns:
            Any: 配置值
        """
        return self.config.get(key, default)
        
    def set(self, key: str, value: Any):
        """
        设置配置值
        
        Args:
            key: 配置键
            value: 配置值
        """
        self.config[key] = value
        self._save_config()
        
    def _save_config(self):
        """保存配置"""
        with open(self.config_file, 'w', encoding='utf-8') as f:
            json.dump(self.config, f, ensure_ascii=False, indent=2)
```

通过以上接口和依赖关系定义，我们建立了一个清晰、模块化的架构，为后续的代码拆分和PyQt6重构奠定了坚实的基础。